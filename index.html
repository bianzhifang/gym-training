<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Gym Training Pro V2.5 - æ™ºèƒ½è®­ç»ƒ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); 
            color: #eee; 
            min-height: 100vh; 
            overflow-x: hidden;
            padding-bottom: 80px;
        }
        
        .container { max-width: 800px; margin: 0 auto; padding: 15px; padding-bottom: 100px; }
        .hidden { display: none !important; }
        
        /* é¦–é¡µæ ·å¼ */
        .header { text-align: center; margin-bottom: 20px; position: relative; padding-top: 10px; }
        .header h1 { 
            font-size: 1.5em; 
            background: linear-gradient(45deg, #00d4ff, #7b2cbf); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            margin-bottom: 5px;
            word-break: keep-all;
        }
        .header p { font-size: 0.9em; color: #888; }
        
        .settings-btn { 
            position: absolute; 
            right: 0; 
            top: 0; 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: #fff; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        @media (min-width: 768px) {
            .nav-grid { grid-template-columns: repeat(4, 1fr); }
            .header h1 { font-size: 2em; }
        }
        
        .nav-card { 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 16px; 
            padding: 20px 15px; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .nav-card:hover, .nav-card:active { 
            transform: translateY(-3px); 
            background: rgba(255,255,255,0.1); 
            border-color: #00d4ff; 
        }
        .nav-card .icon { font-size: 2em; margin-bottom: 8px; display: block; }
        .nav-card .label { font-size: 1em; font-weight: 600; display: block; margin-bottom: 3px; }
        .nav-card small { color: #888; font-size: 0.8em; }
        
        /* è®­ç»ƒé¡µé¢ */
        .workout-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .back-btn { 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: #fff; 
            padding: 8px 16px; 
            border-radius: 20px; 
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
        }
        .finish-btn { 
            background: linear-gradient(45deg, #00d4ff, #7b2cbf); 
            border: none; 
            color: #fff; 
            padding: 10px 20px; 
            border-radius: 25px; 
            font-weight: bold; 
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
        }
        .finish-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .page-title { font-size: 1.2em; font-weight: 600; flex: 1; text-align: center; }
        
        /* åŠ¨ä½œå¡ç‰‡ - æ–°å¢è¿›åº¦æç¤ºæ ·å¼ */
        .exercise-card { 
            background: rgba(255,255,255,0.05); 
            border-radius: 16px; 
            margin-bottom: 12px; 
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .exercise-card.completed { border-left: 4px solid #4ade80; }
        .exercise-card.has-completed { border-left: 4px solid #f59e0b; } /* éƒ¨åˆ†å®Œæˆé»„è‰²æç¤º */
        
        .exercise-header { 
            padding: 12px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: pointer;
            background: rgba(0,0,0,0.2);
            position: relative;
        }
        
        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-indicator {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #4ade80 0%, #4ade80 var(--progress), transparent var(--progress), transparent 100%);
            transition: all 0.3s;
        }
        
        .exercise-title { font-weight: 600; font-size: 1em; flex: 1; display: flex; align-items: center; gap: 8px; }
        .exercise-title.completed { color: #4ade80; }
        
        /* è¿›åº¦æ–‡å­—æç¤º */
        .progress-text {
            font-size: 0.85em;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .progress-text.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }
        .progress-text.completed {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }
        
        .exercise-meta { color: #888; font-size: 0.85em; margin-top: 3px; }
        .exercise-arrow { 
            transition: transform 0.3s; 
            color: #888;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .exercise-arrow.expanded { transform: rotate(180deg); }
        
        .exercise-note {
            background: rgba(0, 212, 255, 0.15);
            border-left: 3px solid #00d4ff;
            padding: 8px 12px;
            margin: 8px 15px;
            border-radius: 0 8px 8px 0;
            font-size: 0.85em;
            color: #a5f3fc;
            line-height: 1.4;
        }
        
        /* å®ŒæˆæŒ‰é’®æ ·å¼ä¼˜åŒ– */
        .batch-complete-btn { 
            background: rgba(74, 222, 128, 0.2); 
            color: #4ade80; 
            border: 1px solid rgba(74, 222, 128, 0.3);
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 0.75em; 
            cursor: pointer;
            margin-right: 8px;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .batch-complete-btn:active {
            transform: scale(0.95);
        }
        
        .video-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #f472b6;
            text-decoration: none;
            font-size: 0.8em;
            margin-left: 8px;
            background: rgba(244, 114, 182, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            border: 1px solid rgba(244, 114, 182, 0.2);
        }
        
        .exercise-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .exercise-body.expanded { max-height: 1200px; }
        .sets-container { padding: 12px 15px; }
        
        .set-row { 
            display: grid; 
            grid-template-columns: 35px 1fr 1fr 45px; 
            gap: 8px; 
            align-items: center; 
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            transition: all 0.2s;
        }
        .set-row.completed { 
            opacity: 0.6; 
            background: rgba(74, 222, 128, 0.1);
        }
        .set-num { color: #888; font-weight: 600; font-size: 0.9em; }
        .set-input { 
            background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.2); 
            color: #fff; 
            padding: 8px; 
            border-radius: 8px; 
            width: 100%;
            text-align: center;
            font-size: 0.9em;
        }
        .set-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* å®ŒæˆæŒ‰é’®ä¼˜åŒ– - å¯å–æ¶ˆ */
        .set-check { 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            border: 2px solid rgba(255,255,255,0.3); 
            background: transparent; 
            color: #fff; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1em;
            padding: 0;
            transition: all 0.2s;
        }
        .set-check:hover {
            border-color: #4ade80;
            color: #4ade80;
        }
        .set-check.completed { 
            background: #4ade80; 
            border-color: #4ade80; 
            color: #1a1a2e;
        }
        .set-check.completed:hover {
            background: rgba(74, 222, 128, 0.8);
            border-color: rgba(74, 222, 128, 0.8);
        }
        
        .stats-bar { 
            position: fixed; 
            bottom: 70px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0,0,0,0.9); 
            padding: 10px 20px; 
            border-radius: 25px; 
            display: flex; 
            gap: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
            font-size: 0.9em;
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.2em; font-weight: bold; color: #00d4ff; }
        .stat-label { font-size: 0.7em; color: #888; }
        
        /* å–æ¶ˆå®Œæˆæç¤º */
        .undo-hint {
            position: fixed;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(245, 158, 11, 0.9);
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            opacity: 0;
            transition: all 0.3s;
            z-index: 99;
            pointer-events: none;
        }
        .undo-hint.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜... */
        .calendar-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px;
            padding: 0 10px;
        }
        .calendar-nav { 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: #fff; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day-header { 
            text-align: center; 
            padding: 8px 2px; 
            color: #888; 
            font-size: 0.8em; 
        }
        .calendar-day { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            background: rgba(255,255,255,0.05); 
            border-radius: 8px; 
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        .calendar-day:hover { background: rgba(255,255,255,0.1); }
        .calendar-day.today { border: 2px solid #00d4ff; }
        .calendar-day.has-workout { background: rgba(74, 222, 128, 0.2); }
        .calendar-day.has-workout::after { 
            content: ''; 
            position: absolute; 
            bottom: 3px; 
            width: 4px; 
            height: 4px; 
            background: #4ade80; 
            border-radius: 50%; 
        }
        .day-number { font-weight: 600; font-size: 0.9em; }
        .day-info { font-size: 0.65em; color: #888; margin-top: 2px; }
        
        .day-detail { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: #1a1a2e; 
            border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 20px; 
            padding: 20px; 
            width: 90%; 
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .detail-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 999; }
        .detail-item { padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .detail-item:last-child { border-bottom: none; }
        
        .settings-section { 
            background: rgba(255,255,255,0.05); 
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 15px; 
        }
        .settings-title { font-size: 1.1em; margin-bottom: 15px; color: #00d4ff; font-weight: 600; }
        .setting-item { margin-bottom: 20px; }
        .setting-item:last-child { margin-bottom: 0; }
        .setting-label { display: block; margin-bottom: 8px; color: #ccc; font-size: 0.9em; }
        .setting-input { 
            width: 100%; 
            padding: 12px; 
            background: rgba(0,0,0,0.3); 
            border: 1px solid rgba(255,255,255,0.2); 
            color: #fff; 
            border-radius: 10px;
            font-size: 0.95em;
        }
        .path-display { 
            background: rgba(0,0,0,0.3); 
            padding: 12px; 
            border-radius: 10px; 
            margin-top: 8px;
            font-family: monospace;
            color: #4ade80;
            word-break: break-all;
            font-size: 0.85em;
            line-height: 1.4;
        }
        .btn-primary { 
            background: linear-gradient(45deg, #00d4ff, #7b2cbf); 
            border: none; 
            color: #fff; 
            padding: 14px; 
            border-radius: 12px; 
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            font-size: 1em;
            margin-top: 10px;
        }
        .btn-secondary { 
            background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.2); 
            color: #fff; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer;
            width: 100%;
            font-size: 0.95em;
            margin-top: 10px;
        }
        
        .template-list { margin-top: 15px; }
        .template-item { 
            background: rgba(255,255,255,0.05); 
            padding: 15px; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            display: flex; 
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .template-info { flex: 1; min-width: 0; margin-right: 10px; }
        .template-info h3 { 
            margin-bottom: 5px; 
            font-size: 1em; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .template-meta { color: #888; font-size: 0.85em; }
        .template-actions { 
            display: flex; 
            gap: 8px; 
            flex-shrink: 0;
        }
        .icon-btn { 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: #fff; 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            flex-shrink: 0;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.2); }
        .icon-btn.delete:hover { background: rgba(239, 68, 68, 0.3); color: #ef4444; }
        .icon-btn.play { background: rgba(0, 212, 255, 0.2); color: #00d4ff; }
        
        .add-template-btn {
            background: linear-gradient(45deg, rgba(0,212,255,0.2), rgba(123,44,191,0.2));
            border: 2px dashed rgba(0,212,255,0.3);
            color: #00d4ff;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .add-template-btn:hover {
            background: rgba(0,212,255,0.1);
            border-color: #00d4ff;
        }
        .add-template-btn .icon { font-size: 1.5em; margin-bottom: 5px; display: block; }
        
        .import-template-btn {
            background: rgba(74, 222, 128, 0.1);
            border: 2px dashed rgba(74, 222, 128, 0.3);
            color: #4ade80;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        .import-template-btn:hover {
            background: rgba(74, 222, 128, 0.2);
            border-color: #4ade80;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        .empty-state .icon { font-size: 3em; margin-bottom: 15px; opacity: 0.5; display: block; }
        
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: rgba(26, 26, 46, 0.98); 
            border-top: 1px solid rgba(255,255,255,0.1); 
            display: flex; 
            justify-content: space-around; 
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom)); 
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
        .nav-item { 
            flex: 1; 
            text-align: center; 
            padding: 8px; 
            color: #888; 
            text-decoration: none;
            font-size: 0.75em;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .nav-item.active { color: #00d4ff; }
        .nav-item .nav-icon { font-size: 1.4em; margin-bottom: 4px; display: block; }
        
        .install-banner { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: linear-gradient(45deg, #00d4ff, #7b2cbf); 
            color: #fff; 
            padding: 12px; 
            text-align: center; 
            z-index: 10000;
            transform: translateY(-100%);
            transition: transform 0.3s;
            font-size: 0.9em;
        }
        .install-banner.show { transform: translateY(0); }
        .install-banner button { 
            background: #fff; 
            color: #7b2cbf; 
            border: none; 
            padding: 6px 16px; 
            border-radius: 20px; 
            margin-left: 10px; 
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9em;
        }
        .install-banner button.secondary {
            background: transparent;
            color: #fff;
            border: 1px solid #fff;
        }
        
        .offline-bar { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            background: #f59e0b; 
            color: #000; 
            padding: 6px; 
            text-align: center; 
            display: none;
            z-index: 9999;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .modal { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.8); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: 20px;
        }
        .modal.show { opacity: 1; pointer-events: auto; }
        .modal-content { 
            background: #1a1a2e; 
            border: 1px solid rgba(255,255,255,0.2); 
            border-radius: 20px; 
            padding: 20px; 
            width: 100%; 
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-header { 
            margin-bottom: 20px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { color: #00d4ff; font-size: 1.3em; }
        .close-modal { 
            background: rgba(255,255,255,0.1); 
            border: none; 
            color: #888; 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; color: #ccc; font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            background: rgba(0,0,0,0.3); 
            border: 1px solid rgba(255,255,255,0.2); 
            color: #fff; 
            border-radius: 10px;
            font-size: 0.95em;
            font-family: inherit;
        }
        .form-group textarea {
            min-height: 200px;
            resize: vertical;
        }
        
        .exercise-list-editor { margin-bottom: 15px; }
        .exercise-input-row { 
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .exercise-basic {
            display: grid; 
            grid-template-columns: 1fr 70px 70px 36px; 
            gap: 8px; 
            align-items: center;
            margin-bottom: 8px;
        }
        .exercise-advanced {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .exercise-advanced input {
            padding: 8px;
            font-size: 0.85em;
        }
        
        .btn-add { 
            background: rgba(74, 222, 128, 0.2); 
            color: #4ade80; 
            border: 1px solid rgba(74, 222, 128, 0.3); 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer;
            width: 100%;
            font-size: 0.9em;
            font-weight: 600;
        }
        .btn-remove { 
            background: rgba(239, 68, 68, 0.2); 
            color: #ef4444; 
            border: 1px solid rgba(239, 68, 68, 0.3); 
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
        }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .modal-actions button { flex: 1; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-size: 0.95em; font-weight: 600; }
        .btn-cancel { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-save { background: linear-gradient(45deg, #00d4ff, #7b2cbf); color: #fff; }
        
        .ai-import-textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.5;
        }
        .ai-import-hint {
            color: #888;
            font-size: 0.8em;
            margin-top: 8px;
            line-height: 1.5;
        }
        .ai-import-hint code {
            background: rgba(0,212,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: #00d4ff;
        }
        
        .via-warning { 
            background: rgba(239, 68, 68, 0.15); 
            border: 1px solid rgba(239, 68, 68, 0.3); 
            color: #fca5a5; 
            padding: 12px; 
            border-radius: 10px; 
            margin-bottom: 15px;
            font-size: 0.85em;
            line-height: 1.5;
        }
        .via-warning strong { color: #ef4444; }
        
        .toast { 
            position: fixed; 
            bottom: 90px; 
            left: 50%; 
            transform: translateX(-50%) translateY(100px); 
            background: rgba(0,0,0,0.9); 
            color: #fff; 
            padding: 12px 24px; 
            border-radius: 25px; 
            opacity: 0;
            transition: all 0.3s;
            z-index: 3000;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 0.9em;
            text-align: center;
            max-width: 90%;
            word-break: break-all;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        .stats-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            margin-top: 20px;
        }
        .stats-card h3 { 
            color: #00d4ff; 
            margin-bottom: 15px; 
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }
        .stat-box .number { 
            font-size: 1.8em; 
            font-weight: bold; 
            margin-bottom: 3px;
        }
        .stat-box .number.green { color: #4ade80; }
        .stat-box .number.blue { color: #00d4ff; }
        .stat-box .number.pink { color: #f472b6; }
        .stat-box .label { color: #888; font-size: 0.8em; }
    </style>
</head>
<body>
    <div class="offline-bar" id="offlineBar">å·²åˆ‡æ¢åˆ°ç¦»çº¿æ¨¡å¼</div>
    <div class="undo-hint" id="undoHint">ç‚¹å‡»å®ŒæˆæŒ‰é’®å¯å–æ¶ˆå®ŒæˆçŠ¶æ€</div>
    
    <div class="install-banner" id="installBanner">
        <span>å®‰è£… Gym Training Pro è·å¾—æœ€ä½³ä½“éªŒ</span>
        <div style="margin-top:8px">
            <button onclick="installPWA()">ç«‹å³å®‰è£…</button>
            <button class="secondary" onclick="dismissInstall()">å…³é—­</button>
        </div>
    </div>

    <!-- é¦–é¡µ -->
    <div id="homePage" class="page">
        <div class="container">
            <div class="header">
                <h1>ğŸ’ª Gym Training Pro</h1>
                <p>PPLä¸‰åˆ†åŒ–è®­ç»ƒç³»ç»Ÿ V2.5</p>
                <button class="settings-btn" onclick="showSettings()">âš™ï¸</button>
            </div>
            
            <div id="viaWarning" class="via-warning hidden">
                <strong>âš ï¸ Viaæµè§ˆå™¨å…¼å®¹æ€§è­¦å‘Š</strong><br>
                Viaæµè§ˆå™¨çš„"æ·»åŠ åˆ°ä¸»å±å¹•"åŠŸèƒ½å­˜åœ¨ç¼ºé™·ï¼Œå¯èƒ½å¯¼è‡´åº”ç”¨æ— æ³•ç¦»çº¿ä½¿ç”¨ã€‚<br>
                è¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨å®‰è£…æ­¤åº”ç”¨ã€‚
            </div>
            
            <div class="nav-grid">
                <div class="nav-card" onclick="showTemplates('Push')">
                    <span class="icon">ğŸ‹ï¸â€â™‚ï¸</span>
                    <span class="label">æ¨æ—¥ (Push)</span>
                    <small>èƒ¸/è‚©/ä¸‰å¤´</small>
                </div>
                <div class="nav-card" onclick="showTemplates('Pull')">
                    <span class="icon">ğŸ‹ï¸â€â™€ï¸</span>
                    <span class="label">æ‹‰æ—¥ (Pull)</span>
                    <small>èƒŒ/äºŒå¤´</small>
                </div>
                <div class="nav-card" onclick="showTemplates('Legs')">
                    <span class="icon">ğŸ¦µ</span>
                    <span class="label">è…¿æ—¥ (Legs)</span>
                    <small>è…¿éƒ¨/æ ¸å¿ƒ</small>
                </div>
                <div class="nav-card" onclick="showCalendar()">
                    <span class="icon">ğŸ“…</span>
                    <span class="label">è®­ç»ƒæ—¥å†</span>
                    <small>æŸ¥çœ‹å†å²è®°å½•</small>
                </div>
            </div>
            
            <div class="stats-card">
                <h3>ğŸ“Š æœ¬å‘¨ç»Ÿè®¡</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="number green" id="weekDays">0</div>
                        <div class="label">è®­ç»ƒå¤©æ•°</div>
                    </div>
                    <div class="stat-box">
                        <div class="number blue" id="weekVolume">0</div>
                        <div class="label">æ€»å®¹é‡(kg)</div>
                    </div>
                    <div class="stat-box">
                        <div class="number pink" id="weekSets">0</div>
                        <div class="label">æ€»ç»„æ•°</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ¿é€‰æ‹©é¡µ -->
    <div id="templatesPage" class="page hidden">
        <div class="container">
            <div class="workout-header">
                <button class="back-btn" onclick="showHome()">â† è¿”å›</button>
                <div class="page-title" id="templateTypeTitle">é€‰æ‹©æ¨¡æ¿</div>
                <div style="width:60px"></div>
            </div>
            
            <div class="import-template-btn" onclick="openAIImportModal()">
                <span style="font-size:1.3em;display:block;margin-bottom:4px">ğŸ¤–</span>
                <div>AI è¯†åˆ«å¯¼å…¥ / ç²˜è´´ JSON</div>
                <small style="opacity:0.8">æ”¯æŒå¾€æœŸæ¨¡æ¿æ ¼å¼è‡ªåŠ¨è¯†åˆ«</small>
            </div>
            
            <div class="add-template-btn" onclick="openTemplateModal()">
                <span class="icon">â•</span>
                <div>æ–°å»ºè®­ç»ƒæ¨¡æ¿</div>
            </div>
            
            <div id="templatesList" class="template-list"></div>
        </div>
    </div>

    <!-- è®­ç»ƒé¡µé¢ -->
    <div id="workoutPage" class="page hidden">
        <div class="container" style="padding-bottom:140px">
            <div class="workout-header">
                <button class="back-btn" onclick="confirmEndWorkout()">â† ç»“æŸ</button>
                <div style="text-align:center;flex:1">
                    <div id="workoutTitle" style="font-weight:600">è®­ç»ƒ</div>
                    <small id="workoutTimer" style="color:#888;font-size:0.85em">00:00:00</small>
                </div>
                <button class="finish-btn" id="finishBtn" onclick="finishWorkout()">å®Œæˆè®­ç»ƒ</button>
            </div>
            <div id="exercisesContainer"></div>
        </div>
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalVolume">0</div>
                <div class="stat-label">å®¹é‡(kg)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="completedSets">0</div>
                <div class="stat-label">å®Œæˆç»„</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalSets">0</div>
                <div class="stat-label">æ€»ç»„æ•°</div>
            </div>
        </div>
    </div>

    <!-- æ—¥å†é¡µé¢ -->
    <div id="calendarPage" class="page hidden">
        <div class="container">
            <div class="workout-header">
                <button class="back-btn" onclick="showHome()">â† è¿”å›</button>
                <div class="page-title">è®­ç»ƒæ—¥å†</div>
                <button class="btn-secondary" onclick="goToToday()" style="width:auto;padding:8px 16px;font-size:0.85em;margin:0">ä»Šå¤©</button>
            </div>
            
            <div class="calendar-header">
                <button class="calendar-nav" onclick="changeMonth(-1)">â†</button>
                <h3 id="currentMonth" style="font-size:1.1em">2024å¹´1æœˆ</h3>
                <button class="calendar-nav" onclick="changeMonth(1)">â†’</button>
            </div>
            
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <!-- æ•°æ®ç®¡ç†é¡µ -->
    <div id="dataPage" class="page hidden">
        <div class="container">
            <div class="workout-header">
                <button class="back-btn" onclick="showHome()">â† è¿”å›</button>
                <div class="page-title">æ•°æ®ç®¡ç†</div>
                <div style="width:60px"></div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">ğŸ’¾ å¤‡ä»½ä¸æ¢å¤</h3>
                <p style="color:#888;margin-bottom:15px;font-size:0.85em;line-height:1.5">
                    æ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°ï¼Œå»ºè®®å®šæœŸå¤‡ä»½ã€‚<br>
                    <span style="color:#00d4ff">è®¾ç½®å¤‡ä»½è·¯å¾„åï¼Œå°†è‡ªåŠ¨ä¿å­˜åˆ°æŒ‡å®šæ–‡ä»¶å¤¹</span>
                </p>
                
                <div id="viaWarning2" class="via-warning hidden">
                    <strong>Viaæµè§ˆå™¨é™åˆ¶ï¼š</strong>ç”±äºViaæµè§ˆå™¨ä¸æ”¯æŒæ ‡å‡†æ–‡ä»¶ç³»ç»ŸAPIï¼Œå¤‡ä»½å°†ä»¥ä¼ ç»Ÿä¸‹è½½æ–¹å¼ä¿å­˜ã€‚
                </div>
                
                <button class="btn-primary" onclick="manualBackup()" style="margin-bottom:10px">ç«‹å³å¤‡ä»½</button>
                
                <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(this)">
                <button class="btn-secondary" onclick="document.getElementById('importFile').click()">ä»æ–‡ä»¶æ¢å¤</button>
                
                <div style="margin-top:15px;padding:12px;background:rgba(0,0,0,0.3);border-radius:10px">
                    <div style="color:#888;font-size:0.8em;margin-bottom:4px">ä¸Šæ¬¡å¤‡ä»½</div>
                    <div id="lastBackupTime" style="color:#4ade80;font-size:0.9em">ä»æœªå¤‡ä»½</div>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">âš ï¸ å±é™©æ“ä½œ</h3>
                <button class="btn-secondary" onclick="clearAllData()" style="background:rgba(239,68,68,0.2);color:#fca5a5;border-color:rgba(239,68,68,0.3)">
                    æ¸…é™¤æ‰€æœ‰æ•°æ®
                </button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®é¡µé¢ -->
    <div id="settingsPage" class="page hidden">
        <div class="container">
            <div class="workout-header">
                <button class="back-btn" onclick="showHome()">â† è¿”å›</button>
                <div class="page-title">è®¾ç½®</div>
                <div style="width:60px"></div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">ğŸ“ å¤‡ä»½è·¯å¾„é…ç½®</h3>
                <p style="color:#888;margin-bottom:15px;font-size:0.85em;line-height:1.5">
                    è®¾ç½®è‡ªåŠ¨å¤‡ä»½çš„ä¿å­˜ä½ç½®ã€‚è®¾ç½®åï¼Œå¤‡ä»½å°†ç›´æ¥ä¿å­˜åˆ°è¯¥æ–‡ä»¶å¤¹ï¼Œæ— éœ€é‡å¤é€‰æ‹©ã€‚
                </p>
                
                <div class="setting-item">
                    <label class="setting-label">å½“å‰å¤‡ä»½è·¯å¾„</label>
                    <div id="currentBackupPath" class="path-display">æœªè®¾ç½®ï¼ˆå°†ä½¿ç”¨é»˜è®¤ä¸‹è½½ä½ç½®ï¼‰</div>
                    <button class="btn-secondary" onclick="selectBackupDirectory()" style="margin-top:10px">
                        é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¤¹
                    </button>
                    <small style="color:#666;display:block;margin-top:6px;font-size:0.8em">
                        * ä»… Chrome/Edge æµè§ˆå™¨æ”¯æŒæ­¤åŠŸèƒ½ï¼Œå…¶ä»–æµè§ˆå™¨å°†ä½¿ç”¨ä¸‹è½½æ–¹å¼
                    </small>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">å¤‡ä»½æ–‡ä»¶åæ ¼å¼</label>
                    <input type="text" class="setting-input" id="filenameFormat" value="è®­ç»ƒè®°å½•_{YYYY}-{MM}" placeholder="è®­ç»ƒè®°å½•_{YYYY}-{MM}">
                    <small style="color:#666;display:block;margin-top:6px;font-size:0.8em">
                        å¯ç”¨å˜é‡ï¼š{YYYY}å¹´, {MM}æœˆ, {DD}æ—¥, {TYPE}ç±»å‹
                    </small>
                </div>
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="useFilePicker" checked>
                    <label for="useFilePicker">ä½¿ç”¨æ–‡ä»¶é€‰æ‹©å™¨ï¼ˆå¦‚æµè§ˆå™¨æ”¯æŒï¼‰</label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3 class="settings-title">ğŸ”„ è‡ªåŠ¨å¤‡ä»½</h3>
                <div class="checkbox-wrapper" style="margin:0">
                    <input type="checkbox" id="autoBackup" checked>
                    <label for="autoBackup">è®­ç»ƒå®Œæˆåè‡ªåŠ¨å¤‡ä»½</label>
                </div>
            </div>
            
            <button class="btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <!-- æ¨¡æ¿ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ–°å»ºæ¨¡æ¿</h2>
                <button class="close-modal" onclick="closeTemplateModal()">âœ•</button>
            </div>
            
            <div class="form-group">
                <label>æ¨¡æ¿åç§° *</label>
                <input type="text" id="templateName" placeholder="ä¾‹å¦‚ï¼šèƒ¸è‚Œå¼ºåŒ–è®­ç»ƒ">
            </div>
            
            <div class="form-group">
                <label>è®­ç»ƒåˆ†ç±» *</label>
                <select id="templateType">
                    <option value="Push">æ¨æ—¥ (Push) - èƒ¸/è‚©/ä¸‰å¤´</option>
                    <option value="Pull">æ‹‰æ—¥ (Pull) - èƒŒ/äºŒå¤´</option>
                    <option value="Legs">è…¿æ—¥ (Legs) - è…¿éƒ¨/æ ¸å¿ƒ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>åŠ¨ä½œåˆ—è¡¨ <small style="color:#888;font-weight:normal">ï¼ˆå±•å¼€å¡«å†™è§†é¢‘é“¾æ¥å’Œè¦ç‚¹ï¼‰</small></label>
                <div id="exercisesList" class="exercise-list-editor"></div>
                <button class="btn-add" onclick="addExerciseInput()">+ æ·»åŠ åŠ¨ä½œ</button>
            </div>
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeTemplateModal()">å–æ¶ˆ</button>
                <button class="btn-save" onclick="saveTemplate()">ä¿å­˜æ¨¡æ¿</button>
            </div>
        </div>
    </div>

    <!-- AIå¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="aiImportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color:#4ade80">ğŸ¤– AI æ™ºèƒ½å¯¼å…¥</h2>
                <button class="close-modal" onclick="closeAIImportModal()">âœ•</button>
            </div>
            
            <div class="form-group">
                <label>ç²˜è´´æ¨¡æ¿ JSON</label>
                <textarea 
                    id="aiImportTextarea" 
                    class="ai-import-textarea" 
                    placeholder="{ &quot;version&quot;: 7, &quot;types&quot;: { ... } }"
                ></textarea>
                <div class="ai-import-hint">
                    <p>âœ… æ”¯æŒæ ¼å¼ï¼š</p>
                    <p>1. æ—§ç‰ˆå¤‡ä»½ï¼š<code>types: { Push: {templates: [...]} }</code></p>
                    <p>2. æ–°ç‰ˆæ ¼å¼ï¼š<code>templates: [...]</code> æ•°ç»„</p>
                    <p>3. å¾€æœŸæ ¼å¼ï¼š<code>type + templates</code> ç»„åˆ</p>
                    <p>4. å•æ¨¡æ¿å¯¹è±¡ï¼šç›´æ¥ç²˜è´´æ¨¡æ¿å¯¹è±¡</p>
                    <p style="margin-top:8px;color:#00d4ff">ğŸ’¡ è‡ªåŠ¨è¯†åˆ« videoã€timestampã€note ç­‰å­—æ®µ</p>
                </div>
            </div>
            
            <div class="form-group">
                <label>æˆ–é€‰æ‹© JSON æ–‡ä»¶</label>
                <input type="file" id="aiImportFile" accept=".json" onchange="handleAIImportFile(this)" style="padding:10px 0">
            </div>
            
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeAIImportModal()">å–æ¶ˆ</button>
                <button class="btn-save" onclick="processAIImport()" style="background:linear-gradient(45deg, #4ade80, #00d4ff)">æ™ºèƒ½è¯†åˆ«å¹¶å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <!-- æ—¥æœŸè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="dayDetailModal" class="modal" onclick="closeDayDetail(event)">
        <div class="day-detail" onclick="event.stopPropagation()">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
                <h3 id="detailDate" style="color:#00d4ff;font-size:1.2em">2024-01-01</h3>
                <button class="close-modal" onclick="closeDayDetail()">âœ•</button>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" onclick="showHome();return false">
            <span class="nav-icon">ğŸ </span>
            <span>é¦–é¡µ</span>
        </a>
        <a href="#" class="nav-item" onclick="showCalendar();return false">
            <span class="nav-icon">ğŸ“…</span>
            <span>æ—¥å†</span>
        </a>
        <a href="#" class="nav-item" onclick="showDataPage();return false">
            <span class="nav-icon">ğŸ’¾</span>
            <span>æ•°æ®</span>
        </a>
    </nav>

    <script>
        // ==================== å…¨å±€çŠ¶æ€ ====================
        let currentPage = 'home';
        let currentWorkout = null;
        let workoutTimer = null;
        let workoutSeconds = 0;
        let currentTemplates = [];
        let editingTemplateId = null;
        let calendarCurrentDate = new Date();
        let appSettings = {
            filenameFormat: 'è®­ç»ƒè®°å½•_{YYYY}-{MM}',
            useFilePicker: true,
            autoBackup: true,
            backupDirectoryHandle: null,
            backupDirectoryName: null
        };
        let isInitialized = false;
        let currentExpandedIndex = 0; // å½“å‰å±•å¼€çš„åŠ¨ä½œç´¢å¼•
        
        function getDefaultTemplates() {
            return [
                { id: 'default_push_1', name: 'æ ‡å‡†æ¨æ—¥', typeKey: 'Push', exercises: [
                    { name: 'æ é“ƒå§æ¨', sets: 4, defaultReps: 8, defaultWeight: 60, video: '', note: '' },
                    { name: 'å“‘é“ƒæ¨ä¸¾', sets: 3, defaultReps: 10, defaultWeight: 20, video: '', note: '' },
                    { name: 'ä¸‰å¤´ä¸‹å‹', sets: 3, defaultReps: 12, defaultWeight: 25, video: '', note: '' }
                ]},
                { id: 'default_pull_1', name: 'æ ‡å‡†æ‹‰æ—¥', typeKey: 'Pull', exercises: [
                    { name: 'å¼•ä½“å‘ä¸Š', sets: 4, defaultReps: 8, defaultWeight: 0, video: '', note: '' },
                    { name: 'æ é“ƒåˆ’èˆ¹', sets: 4, defaultReps: 10, defaultWeight: 50, video: '', note: '' },
                    { name: 'äºŒå¤´å¼¯ä¸¾', sets: 3, defaultReps: 12, defaultWeight: 15, video: '', note: '' }
                ]},
                { id: 'default_legs_1', name: 'æ ‡å‡†è…¿æ—¥', typeKey: 'Legs', exercises: [
                    { name: 'æ·±è¹²', sets: 4, defaultReps: 8, defaultWeight: 80, video: '', note: '' },
                    { name: 'è…¿ä¸¾', sets: 3, defaultReps: 10, defaultWeight: 100, video: '', note: '' },
                    { name: 'è…¿å¼¯ä¸¾', sets: 3, defaultReps: 12, defaultWeight: 30, video: '', note: '' }
                ]}
            ];
        }

        // ==================== æ•°æ®åº“ç®¡ç† ====================
        class DatabaseManager {
            constructor() {
                this.dbName = 'gymDB_v10';
                this.dbVersion = 10;
                this.db = null;
            }
            
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('types')) {
                            const typeStore = db.createObjectStore('types', { keyPath: 'key' });
                            typeStore.createIndex('order', 'order', { unique: false });
                            typeStore.add({ key: 'Push', name: 'æ¨æ—¥', order: 1 });
                            typeStore.add({ key: 'Pull', name: 'æ‹‰æ—¥', order: 2 });
                            typeStore.add({ key: 'Legs', name: 'è…¿æ—¥', order: 3 });
                        }
                        if (!db.objectStoreNames.contains('templates')) {
                            db.createObjectStore('templates', { keyPath: 'uniqueId' });
                        }
                        if (!db.objectStoreNames.contains('records')) {
                            db.createObjectStore('records', { keyPath: 'date' });
                        }
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }
                    };
                });
            }
            
            async getTemplates() {
                return new Promise((resolve) => {
                    try {
                        const transaction = this.db.transaction(['templates'], 'readonly');
                        const store = transaction.objectStore('templates');
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => resolve([]);
                    } catch (e) { resolve([]); }
                });
            }
            
            async saveTemplate(template) {
                return new Promise((resolve, reject) => {
                    try {
                        const transaction = this.db.transaction(['templates'], 'readwrite');
                        const store = transaction.objectStore('templates');
                        const request = store.put(template);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    } catch (e) { reject(e); }
                });
            }
            
            async deleteTemplate(uniqueId) {
                return new Promise((resolve, reject) => {
                    try {
                        const transaction = this.db.transaction(['templates'], 'readwrite');
                        const store = transaction.objectStore('templates');
                        const request = store.delete(uniqueId);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    } catch (e) { reject(e); }
                });
            }
            
            async getRecords() {
                return new Promise((resolve) => {
                    try {
                        const transaction = this.db.transaction(['records'], 'readonly');
                        const store = transaction.objectStore('records');
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => resolve([]);
                    } catch (e) { resolve([]); }
                });
            }
            
            async saveRecord(record) {
                return new Promise((resolve, reject) => {
                    try {
                        const transaction = this.db.transaction(['records'], 'readwrite');
                        const store = transaction.objectStore('records');
                        const request = store.put(record);
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    } catch (e) { reject(e); }
                });
            }
            
            async getSetting(key) {
                return new Promise((resolve) => {
                    try {
                        const transaction = this.db.transaction(['settings'], 'readonly');
                        const store = transaction.objectStore('settings');
                        const request = store.get(key);
                        request.onsuccess = () => resolve(request.result ? request.result.value : null);
                        request.onerror = () => resolve(null);
                    } catch (e) { resolve(null); }
                });
            }
            
            async saveSetting(key, value) {
                return new Promise((resolve, reject) => {
                    try {
                        const transaction = this.db.transaction(['settings'], 'readwrite');
                        const store = transaction.objectStore('settings');
                        const request = store.put({ key, value });
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    } catch (e) { reject(e); }
                });
            }
            
            async clearAll() {
                return new Promise((resolve, reject) => {
                    try {
                        const transaction = this.db.transaction(['templates', 'records', 'settings'], 'readwrite');
                        if (transaction.db.objectStoreNames.contains('templates')) {
                            transaction.objectStore('templates').clear();
                        }
                        if (transaction.db.objectStoreNames.contains('records')) {
                            transaction.objectStore('records').clear();
                        }
                        if (transaction.db.objectStoreNames.contains('settings')) {
                            transaction.objectStore('settings').clear();
                        }
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    } catch (e) { reject(e); }
                });
            }
        }

        const db = new DatabaseManager();

        // ==================== å¤‡ä»½ç®¡ç†å™¨ ====================
        class BackupManager {
            constructor() {
                this.backupKeyPrefix = 'gym_backup_';
            }
            
            getCycleId(date = new Date()) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }
            
            generateFilename(type = 'auto', date = new Date()) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                let filename = appSettings.filenameFormat
                    .replace('{YYYY}', year)
                    .replace('{MM}', month)
                    .replace('{DD}', day)
                    .replace('{TYPE}', type);
                return filename + '.json';
            }
            
            async backupAfterTraining(record) {
                try {
                    const records = await db.getRecords();
                    const cycleId = this.getCycleId();
                    const filename = this.generateFilename('auto');
                    const backupData = {
                        version: 10,
                        type: 'auto_backup',
                        cycleId: cycleId,
                        createdAt: new Date().toISOString(),
                        records: records
                    };
                    if (appSettings.backupDirectoryHandle) {
                        try {
                            await this.saveToDirectory(backupData, filename);
                            showToast('å·²è‡ªåŠ¨å¤‡ä»½');
                            await db.saveSetting('lastBackup', new Date().toISOString());
                            return;
                        } catch (e) {
                            console.log('ç›®å½•ä¿å­˜å¤±è´¥:', e);
                        }
                    }
                    this.downloadFile(backupData, filename);
                    await db.saveSetting('lastBackup', new Date().toISOString());
                } catch (error) {
                    console.error('è‡ªåŠ¨å¤‡ä»½å¤±è´¥:', error);
                }
            }
            
            async manualBackup() {
                try {
                    const records = await db.getRecords();
                    const templates = await db.getTemplates();
                    const date = new Date();
                    const filename = this.generateFilename('manual', date);
                    const backupData = {
                        version: 10,
                        type: 'manual_backup',
                        createdAt: date.toISOString(),
                        records: records,
                        templates: templates
                    };
                    if (appSettings.backupDirectoryHandle) {
                        try {
                            await this.saveToDirectory(backupData, filename);
                            showToast('å¤‡ä»½å·²ä¿å­˜');
                            await db.saveSetting('lastBackup', date.toISOString());
                            updateLastBackupTime();
                            return;
                        } catch (e) {
                            console.log('ç›®å½•ä¿å­˜å¤±è´¥:', e);
                            appSettings.backupDirectoryHandle = null;
                            appSettings.backupDirectoryName = null;
                            await this.saveSettingsToDB();
                        }
                    }
                    if (appSettings.useFilePicker && 'showSaveFilePicker' in window) {
                        try {
                            const handle = await window.showSaveFilePicker({
                                suggestedName: filename,
                                types: [{
                                    description: 'JSONæ–‡ä»¶',
                                    accept: { 'application/json': ['.json'] }
                                }]
                            });
                            const writable = await handle.createWritable();
                            await writable.write(JSON.stringify(backupData, null, 2));
                            await writable.close();
                            showToast('å¤‡ä»½æˆåŠŸ');
                            await db.saveSetting('lastBackup', date.toISOString());
                            updateLastBackupTime();
                        } catch (e) {
                            if (e.name !== 'AbortError') {
                                this.downloadFile(backupData, filename);
                                await db.saveSetting('lastBackup', date.toISOString());
                                updateLastBackupTime();
                            }
                        }
                    } else {
                        this.downloadFile(backupData, filename);
                        await db.saveSetting('lastBackup', date.toISOString());
                        updateLastBackupTime();
                    }
                } catch (error) {
                    console.error('æ‰‹åŠ¨å¤‡ä»½å¤±è´¥:', error);
                    showToast('å¤‡ä»½å¤±è´¥ï¼š' + error.message);
                }
            }
            
            async saveToDirectory(data, filename) {
                if (!appSettings.backupDirectoryHandle) {
                    throw new Error('No directory handle');
                }
                try {
                    const options = { mode: 'readwrite' };
                    const permission = await appSettings.backupDirectoryHandle.queryPermission(options);
                    if (permission !== 'granted') {
                        const requestResult = await appSettings.backupDirectoryHandle.requestPermission(options);
                        if (requestResult !== 'granted') {
                            throw new Error('Permission denied');
                        }
                    }
                    const fileHandle = await appSettings.backupDirectoryHandle.getFileHandle(filename, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(data, null, 2));
                    await writable.close();
                } catch (e) {
                    console.error('ä¿å­˜åˆ°ç›®å½•å¤±è´¥:', e);
                    throw e;
                }
            }
            
            downloadFile(data, filename) {
                try {
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    showToast('æ–‡ä»¶å·²ä¸‹è½½');
                } catch (e) {
                    console.error('ä¸‹è½½å¤±è´¥:', e);
                    showToast('ä¸‹è½½å¤±è´¥');
                }
            }
            
            async saveSettingsToDB() {
                const settingsToSave = {
                    filenameFormat: appSettings.filenameFormat,
                    useFilePicker: appSettings.useFilePicker,
                    autoBackup: appSettings.autoBackup,
                    backupDirectoryName: appSettings.backupDirectoryName
                };
                await db.saveSetting('appSettings', settingsToSave);
            }
        }

        const backupManager = new BackupManager();

        // ==================== AI æ™ºèƒ½å¯¼å…¥ ====================
        function openAIImportModal() {
            const textarea = document.getElementById('aiImportTextarea');
            const fileInput = document.getElementById('aiImportFile');
            if (textarea) textarea.value = '';
            if (fileInput) fileInput.value = '';
            const modal = document.getElementById('aiImportModal');
            if (modal) modal.classList.add('show');
        }
        
        function closeAIImportModal() {
            const modal = document.getElementById('aiImportModal');
            if (modal) modal.classList.remove('show');
        }
        
        async function handleAIImportFile(input) {
            const file = input.files[0];
            if (!file) return;
            try {
                const text = await file.text();
                const textarea = document.getElementById('aiImportTextarea');
                if (textarea) textarea.value = text;
                showToast('æ–‡ä»¶å·²åŠ è½½ï¼Œè¯·ç‚¹å‡»å¯¼å…¥');
            } catch (e) {
                showToast('è¯»å–æ–‡ä»¶å¤±è´¥');
            }
        }
        
        async function processAIImport() {
            const textarea = document.getElementById('aiImportTextarea');
            if (!textarea || !textarea.value.trim()) {
                showToast('è¯·ç²˜è´´ JSON æ•°æ®');
                return;
            }
            try {
                let data = JSON.parse(textarea.value.trim());
                let templates = [];
                let importCount = 0;
                
                console.log('æ­£åœ¨è¯†åˆ«æ•°æ®æ ¼å¼:', Object.keys(data));
                
                if (data.types && typeof data.types === 'object') {
                    console.log('è¯†åˆ«ä¸ºæ—§ç‰ˆ types å¯¹è±¡æ ¼å¼');
                    for (const [typeKey, typeData] of Object.entries(data.types)) {
                        if (typeData && Array.isArray(typeData.templates)) {
                            const mappedType = mapTypeToKey(typeKey);
                            typeData.templates.forEach(t => {
                                templates.push({ ...t, typeKey: mappedType, sourceType: typeKey });
                            });
                        } else if (Array.isArray(typeData)) {
                            const mappedType = mapTypeToKey(typeKey);
                            typeData.forEach(t => {
                                templates.push({ ...t, typeKey: mappedType });
                            });
                        }
                    }
                } else if (data.templates && Array.isArray(data.templates)) {
                    console.log('è¯†åˆ«ä¸ºæ ‡å‡† templates æ•°ç»„æ ¼å¼');
                    templates = data.templates;
                } else if (data.type && data.templates && Array.isArray(data.templates)) {
                    console.log('è¯†åˆ«ä¸ºæœŸæ ¼å¼ï¼ˆå«typeå­—æ®µï¼‰');
                    templates = data.templates.map(t => ({
                        ...t,
                        typeKey: mapTypeToKey(data.type)
                    }));
                } else if (data.name && data.exercises && Array.isArray(data.exercises)) {
                    console.log('è¯†åˆ«ä¸ºå•æ¨¡æ¿å¯¹è±¡');
                    templates = [data];
                } else if (Array.isArray(data)) {
                    console.log('è¯†åˆ«ä¸ºçº¯æ•°ç»„æ ¼å¼');
                    templates = data;
                } else if (Object.keys(data).some(k => ['Push', 'Pull', 'Legs', 'æ¨', 'æ‹‰', 'è…¿'].includes(k))) {
                    console.log('è¯†åˆ«ä¸ºåˆ†ç±»é”®æ ¼å¼');
                    for (const [typeKey, typeData] of Object.entries(data)) {
                        if (typeData && (Array.isArray(typeData.templates) || Array.isArray(typeData))) {
                            const templatesArr = Array.isArray(typeData) ? typeData : typeData.templates;
                            const mappedType = mapTypeToKey(typeKey);
                            templatesArr.forEach(t => {
                                templates.push({ ...t, typeKey: mappedType });
                            });
                        }
                    }
                }
                
                if (templates.length === 0) {
                    throw new Error('æ— æ³•è¯†åˆ«çš„æ•°æ®æ ¼å¼ï¼Œè¯·æ£€æŸ¥ JSON ç»“æ„æ˜¯å¦åŒ…å« templates æˆ– types å­—æ®µ');
                }
                
                console.log(`è¯†åˆ«æˆåŠŸï¼Œå…± ${templates.length} ä¸ªæ¨¡æ¿å¾…å¯¼å…¥`);
                
                for (const template of templates) {
                    const processedTemplate = processTemplate(template);
                    if (processedTemplate) {
                        await db.saveTemplate(processedTemplate);
                        importCount++;
                    }
                }
                
                showToast(`æˆåŠŸå¯¼å…¥ ${importCount} ä¸ªæ¨¡æ¿`);
                           closeAIImportModal();
            renderTemplatesList(currentType);
            loadWeekStats();
        } catch (error) {
            console.error('å¯¼å…¥å¤±è´¥:', error);
            showToast('å¯¼å…¥å¤±è´¥: ' + error.message);
        }
    }
    
    function mapTypeToKey(type) {
        const typeMap = {
            'Push': 'Push', 'æ¨': 'Push', 'push': 'Push', 'PUSH': 'Push',
            'Pull': 'Pull', 'æ‹‰': 'Pull', 'pull': 'Pull', 'PULL': 'Pull',
            'Legs': 'Legs', 'è…¿': 'Legs', 'legs': 'Legs', 'LEGS': 'Legs',
            'æ¨æ—¥': 'Push', 'æ‹‰æ—¥': 'Pull', 'è…¿æ—¥': 'Legs'
        };
        return typeMap[type] || type || 'Push';
    }
    
    function processTemplate(template) {
        if (!template || !template.name) return null;
        const typeKey = template.typeKey || template.type || 'Push';
        const exercises = (template.exercises || []).map((ex, idx) => ({
            name: ex.name || `åŠ¨ä½œ${idx + 1}`,
            sets: parseInt(ex.sets) || 4,
            defaultReps: parseInt(ex.defaultReps || ex.reps) || 10,
            defaultWeight: parseFloat(ex.defaultWeight || ex.weight) || 0,
            video: ex.video || ex.videoUrl || ex.url || '',
            note: ex.note || ex.tips || ex.desc || ''
        }));
        return {
            uniqueId: template.uniqueId || `${typeKey}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            id: template.id || `template_${Date.now()}`,
            name: template.name,
            typeKey: typeKey,
            exercises: exercises,
            createdAt: template.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
    }

    // ==================== é¡µé¢å¯¼èˆª ====================
    function showPage(pageName) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(pageName + 'Page').classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        if (pageName === 'home') document.querySelectorAll('.nav-item')[0].classList.add('active');
        if (pageName === 'calendar') document.querySelectorAll('.nav-item')[1].classList.add('active');
        if (pageName === 'data') document.querySelectorAll('.nav-item')[2].classList.add('active');
        currentPage = pageName;
        window.scrollTo(0, 0);
    }

    function showHome() {
        showPage('home');
        loadWeekStats();
    }

    function showTemplates(type) {
        currentType = type;
        document.getElementById('templateTypeTitle').textContent = type + 'æ—¥æ¨¡æ¿';
        renderTemplatesList(type);
        showPage('templates');
    }

    async function renderTemplatesList(typeKey) {
        const templates = await db.getTemplates();
        const filtered = templates.filter(t => t.typeKey === typeKey);
        const container = document.getElementById('templatesList');
        
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <span class="icon">ğŸ“­</span>
                    <p>æš‚æ— ${typeKey}æ—¥æ¨¡æ¿</p>
                    <p style="font-size:0.85em;margin-top:8px">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºæˆ–å¯¼å…¥</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filtered.map(t => `
            <div class="template-item">
                <div class="template-info">
                    <h3>${escapeHtml(t.name)}</h3>
                    <div class="template-meta">${t.exercises ? t.exercises.length : 0} ä¸ªåŠ¨ä½œ Â· ${t.exercises ? t.exercises.reduce((sum, ex) => sum + (parseInt(ex.sets) || 0), 0) : 0} ç»„</div>
                </div>
                <div class="template-actions">
                    <button class="icon-btn play" onclick="startWorkout('${t.uniqueId}')" title="å¼€å§‹è®­ç»ƒ">â–¶</button>
                    <button class="icon-btn" onclick="editTemplate('${t.uniqueId}')" title="ç¼–è¾‘">âœï¸</button>
                    <button class="icon-btn delete" onclick="deleteTemplate('${t.uniqueId}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==================== è®­ç»ƒåŠŸèƒ½ ====================
    async function startWorkout(templateId) {
        const templates = await db.getTemplates();
        const template = templates.find(t => t.uniqueId === templateId);
        if (!template) {
            showToast('æ¨¡æ¿ä¸å­˜åœ¨');
            return;
        }
        
        currentWorkout = {
            templateId: templateId,
            templateName: template.name,
            typeKey: template.typeKey,
            startTime: new Date(),
            exercises: template.exercises.map((ex, exIndex) => ({
                name: ex.name,
                video: ex.video,
                note: ex.note,
                sets: Array.from({ length: parseInt(ex.sets) || 4 }, (_, i) => ({
                    setNum: i + 1,
                    reps: ex.defaultReps || 10,
                    weight: ex.defaultWeight || 0,
                    completed: false,
                    completedAt: null
                }))
            })),
            isExpanded: template.exercises.map(() => false)
        };
        
        currentWorkout.isExpanded[0] = true;
        currentExpandedIndex = 0;
        
        document.getElementById('workoutTitle').textContent = template.name;
        renderWorkout();
        startTimer();
        showPage('workout');
        
        setTimeout(() => {
            const undoHint = document.getElementById('undoHint');
            if (undoHint) {
                undoHint.classList.add('show');
                setTimeout(() => undoHint.classList.remove('show'), 5000);
            }
        }, 1000);
    }

    function renderWorkout() {
        const container = document.getElementById('exercisesContainer');
        if (!currentWorkout) return;
        
        let totalVolume = 0;
        let completedSets = 0;
        let totalSets = 0;
        
        container.innerHTML = currentWorkout.exercises.map((ex, exIndex) => {
            const exCompletedSets = ex.sets.filter(s => s.completed).length;
            const exTotalSets = ex.sets.length;
            const isExpanded = currentWorkout.isExpanded[exIndex];
            const allCompleted = exCompletedSets === exTotalSets && exTotalSets > 0;
            const someCompleted = exCompletedSets > 0 && exCompletedSets < exTotalSets;
            
            totalSets += exTotalSets;
            completedSets += exCompletedSets;
            
            ex.sets.forEach(set => {
                if (set.completed) {
                    totalVolume += (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0);
                }
            });
            
            const progressPercent = exTotalSets > 0 ? (exCompletedSets / exTotalSets) * 100 : 0;
            
            return `
                <div class="exercise-card ${allCompleted ? 'completed' : ''} ${someCompleted ? 'has-completed' : ''}">
                    <div class="progress-indicator" style="--progress: ${progressPercent}%"></div>
                    <div class="exercise-header" onclick="toggleExerciseCollapse(${exIndex})">
                        <div style="flex:1;min-width:0">
                            <div class="exercise-title ${allCompleted ? 'completed' : ''}">
                                ${escapeHtml(ex.name)}
                                ${allCompleted ? 'âœ“' : ''}
                                <span class="progress-text ${allCompleted ? 'completed' : 'pending'}">
                                    ${exCompletedSets}/${exTotalSets}
                                </span>
                            </div>
                            ${ex.note ? `<div class="exercise-meta">${escapeHtml(ex.note)}</div>` : ''}
                        </div>
                        <div style="display:flex;align-items:center">
                            ${exCompletedSets < exTotalSets ? `
                                <button class="batch-complete-btn" onclick="event.stopPropagation();batchCompleteExercise(${exIndex})">
                                    âœ“ å…¨éƒ¨å®Œæˆ
                                </button>
                            ` : ''}
                            ${ex.video ? `
                                <a href="${ex.video}" target="_blank" class="video-link" onclick="event.stopPropagation()">
                                    ğŸ“¹ è§†é¢‘
                                </a>
                            ` : ''}
                            <span class="exercise-arrow ${isExpanded ? 'expanded' : ''}">â–¼</span>
                        </div>
                    </div>
                    <div class="exercise-body ${isExpanded ? 'expanded' : ''}">
                        <div class="sets-container">
                            ${ex.sets.map((set, setIndex) => `
                                <div class="set-row ${set.completed ? 'completed' : ''}">
                                    <span class="set-num">${set.setNum}</span>
                                    <input type="number" class="set-input" placeholder="é‡é‡" 
                                        value="${set.weight}" 
                                        ${set.completed ? 'disabled' : ''}
                                        onchange="updateSet(${exIndex}, ${setIndex}, 'weight', this.value)"
                                        onfocus="selectInput(this)">
                                    <input type="number" class="set-input" placeholder="æ¬¡æ•°" 
                                        value="${set.reps}" 
                                        ${set.completed ? 'disabled' : ''}
                                        onchange="updateSet(${exIndex}, ${setIndex}, 'reps', this.value)"
                                        onfocus="selectInput(this)">
                                    <button class="set-check ${set.completed ? 'completed' : ''}" 
                                        onclick="toggleSetComplete(${exIndex}, ${setIndex})">
                                        ${set.completed ? 'âœ“' : 'â—‹'}
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('totalVolume').textContent = totalVolume.toLocaleString();
        document.getElementById('completedSets').textContent = completedSets;
        document.getElementById('totalSets').textContent = totalSets;
        
        const finishBtn = document.getElementById('finishBtn');
        if (finishBtn) {
            finishBtn.disabled = completedSets === 0;
        }
    }

    function selectInput(input) {
        input.select();
    }

    function toggleExerciseCollapse(exIndex) {
        if (!currentWorkout) return;
        currentWorkout.isExpanded[exIndex] = !currentWorkout.isExpanded[exIndex];
        if (currentWorkout.isExpanded[exIndex]) {
            currentExpandedIndex = exIndex;
            currentWorkout.isExpanded.forEach((_, idx) => {
                if (idx !== exIndex) currentWorkout.isExpanded[idx] = false;
            });
        }
        renderWorkout();
    }

    function updateSet(exIndex, setIndex, field, value) {
        if (!currentWorkout) return;
        currentWorkout.exercises[exIndex].sets[setIndex][field] = value;
        renderWorkout();
    }

    function toggleSetComplete(exIndex, setIndex) {
        if (!currentWorkout) return;
        const set = currentWorkout.exercises[exIndex].sets[setIndex];
        set.completed = !set.completed;
        set.completedAt = set.completed ? new Date().toISOString() : null;
        renderWorkout();
        
        const allCompleted = currentWorkout.exercises[exIndex].sets.every(s => s.completed);
        if (allCompleted && set.completed) {
            if (exIndex < currentWorkout.exercises.length - 1) {
                setTimeout(() => {
                    toggleExerciseCollapse(exIndex + 1);
                }, 300);
            }
        }
    }

    function batchCompleteExercise(exIndex) {
        if (!currentWorkout) return;
        currentWorkout.exercises[exIndex].sets.forEach(set => {
            set.completed = true;
            set.completedAt = new Date().toISOString();
        });
        renderWorkout();
        
        if (exIndex < currentWorkout.exercises.length - 1) {
            setTimeout(() => {
                toggleExerciseCollapse(exIndex + 1);
            }, 300);
        }
    }

    function startTimer() {
        workoutSeconds = 0;
        if (workoutTimer) clearInterval(workoutTimer);
        workoutTimer = setInterval(() => {
            workoutSeconds++;
            const hours = Math.floor(workoutSeconds / 3600);
            const mins = Math.floor((workoutSeconds % 3600) / 60);
            const secs = workoutSeconds % 60;
            document.getElementById('workoutTimer').textContent = 
                `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }, 1000);
    }

    function confirmEndWorkout() {
        if (confirm('ç¡®å®šè¦ç»“æŸå½“å‰è®­ç»ƒå—ï¼Ÿæœªå®Œæˆçš„ç»„æ•°å°†ä¸ä¼šä¿å­˜ã€‚')) {
            endWorkout();
        }
    }

    function endWorkout() {
        if (workoutTimer) {
            clearInterval(workoutTimer);
            workoutTimer = null;
        }
        currentWorkout = null;
        showHome();
    }

    async function finishWorkout() {
        if (!currentWorkout) return;
        
        const hasCompletedSets = currentWorkout.exercises.some(ex => 
            ex.sets.some(s => s.completed)
        );
        
        if (!hasCompletedSets) {
            showToast('è¯·è‡³å°‘å®Œæˆä¸€ç»„è®­ç»ƒ');
            return;
        }
        
        const record = {
            date: new Date().toISOString().split('T')[0],
            typeKey: currentWorkout.typeKey,
            templateName: currentWorkout.templateName,
            duration: workoutSeconds,
            exercises: currentWorkout.exercises
                .filter(ex => ex.sets.some(s => s.completed))
                .map(ex => ({
                    name: ex.name,
                    sets: ex.sets.filter(s => s.completed).map(s => ({
                        setNum: s.setNum,
                        reps: parseInt(s.reps) || 0,
                        weight: parseFloat(s.weight) || 0,
                        completedAt: s.completedAt
                    }))
                }))
        };
        
        try {
            await db.saveRecord(record);
            
            if (appSettings.autoBackup) {
                await backupManager.backupAfterTraining(record);
            }
            
            if (workoutTimer) {
                clearInterval(workoutTimer);
                workoutTimer = null;
            }
            
            showToast('è®­ç»ƒå·²ä¿å­˜ï¼');
            currentWorkout = null;
            showHome();
        } catch (error) {
            console.error('ä¿å­˜å¤±è´¥:', error);
            showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    // ==================== æ—¥å†åŠŸèƒ½ ====================
    async function showCalendar() {
        showPage('calendar');
        await renderCalendar();
    }

    async function renderCalendar() {
        const year = calendarCurrentDate.getFullYear();
        const month = calendarCurrentDate.getMonth();
        
        document.getElementById('currentMonth').textContent = 
            `${year}å¹´${month + 1}æœˆ`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();
        
        const records = await db.getRecords();
        const recordsMap = new Map();
        records.forEach(r => {
            if (!recordsMap.has(r.date)) {
                recordsMap.set(r.date, []);
            }
            recordsMap.get(r.date).push(r);
        });
        
        const grid = document.getElementById('calendarGrid');
        const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        
        let html = dayNames.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
        
        for (let i = 0; i < startDayOfWeek; i++) {
            html += `<div class="calendar-day" style="opacity:0.3"></div>`;
        }
        
        const today = new Date().toISOString().split('T')[0];
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayRecords = recordsMap.get(dateStr) || [];
            const hasWorkout = dayRecords.length > 0;
            const isToday = dateStr === today;
            
            let totalSets = 0;
            let totalVolume = 0;
            dayRecords.forEach(r => {
                r.exercises.forEach(ex => {
                    ex.sets.forEach(s => {
                        totalSets++;
                        totalVolume += (s.weight || 0) * (s.reps || 0);
                    });
                });
            });
            
            html += `
                <div class="calendar-day ${isToday ? 'today' : ''} ${hasWorkout ? 'has-workout' : ''}" 
                     onclick="showDayDetail('${dateStr}')">
                    <span class="day-number">${day}</span>
                    ${hasWorkout ? `<span class="day-info">${totalSets}ç»„</span>` : ''}
                </div>
            `;
        }
        
        grid.innerHTML = html;
    }

    function changeMonth(delta) {
        calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + delta);
        renderCalendar();
    }

    function goToToday() {
        calendarCurrentDate = new Date();
        renderCalendar();
    }

    async function showDayDetail(dateStr) {
        const records = await db.getRecords();
        const dayRecords = records.filter(r => r.date === dateStr);
        
        if (dayRecords.length === 0) return;
        
        document.getElementById('detailDate').textContent = dateStr;
        
        let totalVolume = 0;
        let totalSets = 0;
        
        const content = dayRecords.map(r => {
            let exHtml = r.exercises.map(ex => {
                return ex.sets.map(s => {
                    totalVolume += (s.weight || 0) * (s.reps || 0);
                    totalSets++;
                    return `
                        <div style="display:flex;justify-content:space-between;padding:4px 0;font-size:0.9em;color:#ccc">
                            <span>${escapeHtml(ex.name)} ${s.setNum}</span>
                            <span>${s.weight}kg Ã— ${s.reps}</span>
                        </div>
                    `;
                }).join('');
            }).join('');
            
            return `
                <div class="detail-item">
                    <div style="color:#00d4ff;font-weight:600;margin-bottom:8px">${r.templateName}</div>
                    ${exHtml}
                </div>
            `;
        }).join('');
        
        document.getElementById('detailContent').innerHTML = content + `
            <div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1);text-align:center">
                <div style="font-size:1.2em;font-weight:bold;color:#4ade80">${totalVolume.toLocaleString()} kg</div>
                <div style="font-size:0.8em;color:#888">æ€»å®¹é‡ Â· ${totalSets} ç»„</div>
            </div>
        `;
        
        document.getElementById('dayDetailModal').classList.add('show');
    }

    function closeDayDetail(e) {
        if (!e || e.target.id === 'dayDetailModal') {
            document.getElementById('dayDetailModal').classList.remove('show');
        }
    }

    // ==================== æ¨¡æ¿ç®¡ç† ====================
    let currentEditingId = null;
    let exerciseInputs = [];

    function openTemplateModal(templateId = null) {
        currentEditingId = templateId;
        document.getElementById('modalTitle').textContent = templateId ? 'ç¼–è¾‘æ¨¡æ¿' : 'æ–°å»ºæ¨¡æ¿';
        
        if (templateId) {
            db.getTemplates().then(templates => {
                const t = templates.find(tpl => tpl.uniqueId === templateId);
                if (t) {
                    document.getElementById('templateName').value = t.name;
                    document.getElementById('templateType').value = t.typeKey;
                    exerciseInputs = t.exercises.map(ex => ({...ex}));
                    renderExerciseInputs();
                }
            });
        } else {
            document.getElementById('templateName').value = '';
            document.getElementById('templateType').value = currentType || 'Push';
            exerciseInputs = [{ name: '', sets: 4, defaultReps: 10, defaultWeight: 0, video: '', note: '' }];
            renderExerciseInputs();
        }
        
        document.getElementById('templateModal').classList.add('show');
    }

    function closeTemplateModal() {
        document.getElementById('templateModal').classList.remove('show');
        currentEditingId = null;
        exerciseInputs = [];
    }

    function addExerciseInput() {
        exerciseInputs.push({ name: '', sets: 4, defaultReps: 10, defaultWeight: 0, video: '', note: '' });
        renderExerciseInputs();
    }

    function removeExerciseInput(index) {
        exerciseInputs.splice(index, 1);
        renderExerciseInputs();
    }

    function updateExerciseInput(index, field, value) {
        if (exerciseInputs[index]) {
            exerciseInputs[index][field] = value;
        }
    }

    function renderExerciseInputs() {
        const container = document.getElementById('exercisesList');
        container.innerHTML = exerciseInputs.map((ex, idx) => `
            <div class="exercise-input-row">
                <div class="exercise-basic">
                    <input type="text" placeholder="åŠ¨ä½œåç§°" value="${ex.name}" 
                        onchange="updateExerciseInput(${idx}, 'name', this.value)" style="font-weight:600">
                    <input type="number" placeholder="ç»„" value="${ex.sets}" 
                        onchange="updateExerciseInput(${idx}, 'sets', this.value)" title="ç»„æ•°">
                    <input type="number" placeholder="æ¬¡" value="${ex.defaultReps}" 
                        onchange="updateExerciseInput(${idx}, 'defaultReps', this.value)" title="é»˜è®¤æ¬¡æ•°">
                    <button class="btn-remove" onclick="removeExerciseInput(${idx})">âœ•</button>
                </div>
                <div class="exercise-advanced">
                    <input type="number" placeholder="é»˜è®¤é‡é‡ (kg)" value="${ex.defaultWeight}" 
                        onchange="updateExerciseInput(${idx}, 'defaultWeight', this.value)">
                    <input type="url" placeholder="æ•™å­¦è§†é¢‘é“¾æ¥ (å¯é€‰)" value="${ex.video}" 
                        onchange="updateExerciseInput(${idx}, 'video', this.value)">
                    <input type="text" placeholder="åŠ¨ä½œè¦ç‚¹/å¤‡æ³¨ (å¯é€‰)" value="${ex.note}" 
                        onchange="updateExerciseInput(${idx}, 'note', this.value)">
                </div>
            </div>
        `).join('');
    }

    async function saveTemplate() {
        const name = document.getElementById('templateName').value.trim();
        const typeKey = document.getElementById('templateType').value;
        
        if (!name) {
            showToast('è¯·è¾“å…¥æ¨¡æ¿åç§°');
            return;
        }
        
        const validExercises = exerciseInputs.filter(ex => ex.name.trim());
        if (validExercises.length === 0) {
            showToast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªåŠ¨ä½œ');
            return;
        }
        
        const template = {
            uniqueId: currentEditingId || `${typeKey}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            id: currentEditingId ? currentEditingId.split('_')[1] || `template_${Date.now()}` : `template_${Date.now()}`,
            name: name,
            typeKey: typeKey,
            exercises: validExercises,
            updatedAt: new Date().toISOString()
        };
        
        if (!currentEditingId) {
            template.createdAt = new Date().toISOString();
        }
        
        try {
            await db.saveTemplate(template);
            showToast(currentEditingId ? 'æ¨¡æ¿å·²æ›´æ–°' : 'æ¨¡æ¿å·²åˆ›å»º');
            closeTemplateModal();
            if (currentPage === 'templates') {
                renderTemplatesList(currentType);
            }
        } catch (error) {
            showToast('ä¿å­˜å¤±è´¥');
        }
    }

    async function editTemplate(templateId) {
        openTemplateModal(templateId);
    }

    async function deleteTemplate(templateId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ')) return;
        
        try {
            await db.deleteTemplate(templateId);
            showToast('æ¨¡æ¿å·²åˆ é™¤');
            renderTemplatesList(currentType);
        } catch (error) {
            showToast('åˆ é™¤å¤±è´¥');
        }
    }

    // ==================== è®¾ç½®ä¸æ•°æ® ====================
    function showSettings() {
        loadSettings();
        showPage('settings');
    }

    function showDataPage() {
        showPage('data');
        updateLastBackupTime();
    }

    async function loadSettings() {
        const saved = await db.getSetting('appSettings');
        if (saved) {
            appSettings = { ...appSettings, ...saved };
        }
        
        document.getElementById('filenameFormat').value = appSettings.filenameFormat;
        document.getElementById('useFilePicker').checked = appSettings.useFilePicker;
        document.getElementById('autoBackup').checked = appSettings.autoBackup;
        
        updateBackupPathDisplay();
    }

    function updateBackupPathDisplay() {
        const pathDisplay = document.getElementById('currentBackupPath');
        if (appSettings.backupDirectoryName) {
            pathDisplay.textContent = `ğŸ“ ${appSettings.backupDirectoryName}`;
            pathDisplay.style.color = '#4ade80';
        } else {
            pathDisplay.textContent = 'æœªè®¾ç½®ï¼ˆå°†ä½¿ç”¨é»˜è®¤ä¸‹è½½ä½ç½®ï¼‰';
            pathDisplay.style.color = '#888';
        }
    }

    async function selectBackupDirectory() {
        if ('showDirectoryPicker' in window) {
            try {
                const dirHandle = await window.showDirectoryPicker();
                appSettings.backupDirectoryHandle = dirHandle;
                appSettings.backupDirectoryName = dirHandle.name;
                updateBackupPathDisplay();
                showToast('å·²é€‰æ‹©æ–‡ä»¶å¤¹: ' + dirHandle.name);
            } catch (e) {
                if (e.name !== 'AbortError') {
                    showToast('é€‰æ‹©æ–‡ä»¶å¤¹å¤±è´¥');
                }
            }
        } else {
            showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶å¤¹é€‰æ‹©ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge');
        }
    }

    async function saveSettings() {
        appSettings.filenameFormat = document.getElementById('filenameFormat').value || 'è®­ç»ƒè®°å½•_{YYYY}-{MM}';
        appSettings.useFilePicker = document.getElementById('useFilePicker').checked;
        appSettings.autoBackup = document.getElementById('autoBackup').checked;
        
        await backupManager.saveSettingsToDB();
        showToast('è®¾ç½®å·²ä¿å­˜');
        showHome();
    }

    async function manualBackup() {
        await backupManager.manualBackup();
    }

    async function updateLastBackupTime() {
        const lastBackup = await db.getSetting('lastBackup');
        const el = document.getElementById('lastBackupTime');
        if (lastBackup) {
            const date = new Date(lastBackup);
            el.textContent = date.toLocaleString('zh-CN');
        } else {
            el.textContent = 'ä»æœªå¤‡ä»½';
        }
    }

    async function importData(input) {
        const file = input.files[0];
        if (!file) return;
        
        try {
            const text = await file.text();
            const data = JSON.parse(text);
            
            if (data.templates && Array.isArray(data.templates)) {
                for (const t of data.templates) {
                    await db.saveTemplate(t);
                }
            }
            if (data.records && Array.isArray(data.records)) {
                for (const r of data.records) {
                    await db.saveRecord(r);
                }
            }
            
            showToast('æ•°æ®å·²æ¢å¤');
            loadWeekStats();
        } catch (e) {
            showToast('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
        }
        input.value = '';
    }

    async function clearAllData() {
        if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
        if (!confirm('å†æ¬¡ç¡®è®¤ï¼šå°†åˆ é™¤æ‰€æœ‰æ¨¡æ¿å’Œè®­ç»ƒè®°å½•ï¼Œç¡®å®šå—ï¼Ÿ')) return;
        
        try {
            await db.clearAll();
            showToast('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤');
            showHome();
        } catch (e) {
            showToast('æ¸…é™¤å¤±è´¥');
        }
    }

    // ==================== ç»Ÿè®¡åŠŸèƒ½ ====================
    async function loadWeekStats() {
        const records = await db.getRecords();
        const today = new Date();
        const weekStart = new Date(today);
        weekStart.setDate(today.getDate() - today.getDay());
        weekStart.setHours(0, 0, 0, 0);
        
        let weekDays = new Set();
        let weekVolume = 0;
        let weekSets = 0;
        
        records.forEach(r => {
            const recordDate = new Date(r.date);
            if (recordDate >= weekStart && recordDate <= today) {
                weekDays.add(r.date);
                r.exercises.forEach(ex => {
                    ex.sets.forEach(s => {
                        weekVolume += (s.weight || 0) * (s.reps || 0);
                        weekSets++;
                    });
                });
            }
        });
        
        document.getElementById('weekDays').textContent = weekDays.size;
        document.getElementById('weekVolume').textContent = weekVolume.toLocaleString();
        document.getElementById('weekSets').textContent = weekSets;
    }

    // ==================== PWA æ”¯æŒ ====================
    let deferredPrompt = null;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        deferredPrompt = e;
        setTimeout(() => {
            const banner = document.getElementById('installBanner');
            if (banner && !window.matchMedia('(display-mode: standalone)').matches) {
                banner.classList.add('show');
            }
        }, 3000);
    });

    function installPWA() {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…');
                }
                deferredPrompt = null;
                document.getElementById('installBanner').classList.remove('show');
            });
        } else {
            showToast('è¯·ä½¿ç”¨æµè§ˆå™¨èœå•ä¸­çš„"å®‰è£…åº”ç”¨"é€‰é¡¹');
        }
    }

    function dismissInstall() {
        document.getElementById('installBanner').classList.remove('show');
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ==================== åˆå§‹åŒ– ====================
    async function init() {
        if (isInitialized) return;
        
        await db.init();
        
        const defaults = getDefaultTemplates();
        const existing = await db.getTemplates();
        
        if (existing.length === 0) {
            for (const t of defaults) {
                await db.saveTemplate(t);
            }
        }
        
        if (navigator.userAgent.includes('Via')) {
            const warnings = document.querySelectorAll('.via-warning');
            warnings.forEach(w => w.classList.remove('hidden'));
        }
        
        window.addEventListener('online', () => {
            document.getElementById('offlineBar').style.display = 'none';
        });
        window.addEventListener('offline', () => {
            document.getElementById('offlineBar').style.display = 'block';
        });
        
        loadWeekStats();
        isInitialized = true;
    }

    window.addEventListener('load', init);
    
    if ('serviceWorker' in navigator) {
        const swCode = `
            self.addEventListener('install', e => self.skipWaiting());
            self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
            self.addEventListener('fetch', e => {
                e.respondWith(
                    caches.match(e.request).then(response => {
                        return response || fetch(e.request).catch(() => caches.match('/'));
                    })
                );
            });
        `;
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl).catch(() => {});
    }
</script>
