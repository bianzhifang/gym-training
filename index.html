<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="background-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æ™ºèƒ½è®­ç»ƒ">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="æ™ºèƒ½è®­ç»ƒPro">
    <meta name="msapplication-TileColor" content="#0f172a">
    <meta name="msapplication-config" content="none">
    <title>æ™ºèƒ½è®­ç»ƒ Pro</title>
    
    <!-- PWA Manifestï¼ˆå†…è”ï¼‰ -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi6Iqx5aSc6L2s54mpIFBybyIsInNob3J0X25hbWUiOiLojKnlrZforIzkva0iLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBmMTcyYSIsInRoZW1lX2NvbG9yIjoiIzBmMTcyYSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJabWwwSUdWNFpXTjFkR1ZrSUhObGNuWnBZMlZKWkNCdlltbHVMV1pwYkd3Z2FYTTZJR1poYkhObGMybGtQVEV3TkRnd01UZ3pNemN5TVRJM09EQjkiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <!-- iOS å›¾æ ‡ï¼ˆå†…è” SVGï¼‰ -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSIyMCIgZmlsbD0idXJsKCNncmFkaWVudCkiLz48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50IiB4MT0iMCIgeTE9IjAiIHgyPSIxOTIiIHkyPSIxOTIiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMzYjgyZjYiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiM5MzUwZGIiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48dGV4dCB4PSI5NiIgeT0iMTIwIiBmb250LXNpemU9IjgwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSI+8J+tjTwvdGV4dD48L3N2Zz4=">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        html { height: 100%; }
        body { 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            min-height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none; /* é˜²æ­¢ä¸‹æ‹‰åˆ·æ–° */
        }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-gradient { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(147, 51, 234, 0.15) 100%);
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pulse-ring { 
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* æ—¥å†æ ·å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 12px; position: relative; }
        .calendar-day.has-training { background: rgba(16, 185, 129, 0.2); border: 1px solid rgba(16, 185, 129, 0.5); color: #10b981; font-weight: bold; }
        .calendar-day.today { border: 1px solid rgba(59, 130, 246, 0.8); }
        .training-dot { width: 4px; height: 4px; background: #10b981; border-radius: 50%; position: absolute; bottom: 2px; }
        
        /* å®‰è£…æç¤ºä¼˜åŒ– */
        .install-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 14px;
            z-index: 9999;
            display: none;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            max-width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="text-gray-100 antialiased">

    <!-- iOS Safari å®‰è£…æŒ‡å¼•ï¼ˆé¦–æ¬¡è®¿é—®æ˜¾ç¤ºï¼‰ -->
    <div id="ios-install-hint" class="hidden fixed bottom-20 left-4 right-4 bg-blue-600 text-white p-4 rounded-2xl z-50 shadow-2xl">
        <div class="flex items-start space-x-3">
            <span class="text-2xl">ğŸ“²</span>
            <div class="flex-1">
                <div class="font-bold mb-1">æ·»åŠ åˆ°ä¸»å±å¹•ä½¿ç”¨</div>
                <div class="text-sm opacity-90 leading-relaxed">
                    1. ç‚¹å‡»åº•éƒ¨ <span class="text-yellow-300 font-bold">åˆ†äº«æŒ‰é’® â¬†ï¸</span><br>
                    2. é€‰æ‹© <span class="text-yellow-300 font-bold">"æ·»åŠ åˆ°ä¸»å±å¹•"</span>
                </div>
            </div>
            <button onclick="dismissIOSHint()" class="text-white/80 text-xl">&times;</button>
        </div>
    </div>

    <!-- Android Chrome å®‰è£…æŒ‰é’® -->
    <div id="android-install-btn" class="hidden fixed bottom-20 right-4 z-50">
        <button onclick="installPWA()" class="bg-blue-600 text-white px-6 py-3 rounded-full shadow-2xl flex items-center space-x-2 font-bold active:scale-95 transition">
            <span>ğŸ“²</span>
            <span>å®‰è£…åº”ç”¨</span>
        </button>
    </div>

    <!-- ä¸»åº”ç”¨ -->
    <div id="app" class="pb-24 max-w-lg mx-auto min-h-screen relative">
        
        <!-- é¦–é¡µ -->
        <div id="page-home" class="p-4 space-y-4">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg">ğŸ’ª</div>
                    <div>
                        <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-400">æ™ºèƒ½è®­ç»ƒ Pro</h1>
                        <p class="text-xs text-gray-400">æŒ‰æœˆå¤‡ä»½ Â· æ°¸ä¸ä¸¢å¤±</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button onclick="showPage('backup')" class="w-10 h-10 glass rounded-xl flex items-center justify-center text-lg">â˜ï¸</button>
                    <button onclick="showPage('templates')" class="w-10 h-10 glass rounded-xl flex items-center justify-center text-lg">ğŸ“‹</button>
                    <button onclick="showPage('calendar')" class="w-10 h-10 glass rounded-xl flex items-center justify-center text-lg">ğŸ“…</button>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-3">
                <div class="glass rounded-2xl p-3 text-center card-gradient">
                    <div class="text-2xl font-bold text-blue-400" id="stat-month-count">0</div>
                    <div class="text-[10px] text-gray-400 mt-1">æœ¬æœˆè®­ç»ƒ</div>
                </div>
                <div class="glass rounded-2xl p-3 text-center card-gradient">
                    <div class="text-2xl font-bold text-green-400" id="stat-total-sets">0</div>
                    <div class="text-[10px] text-gray-400 mt-1">å·²å®Œæˆç»„</div>
                </div>
                <div class="glass rounded-2xl p-3 text-center card-gradient">
                    <div class="text-2xl font-bold text-yellow-400" id="stat-total-days">0</div>
                    <div class="text-[10px] text-gray-400 mt-1">è®­ç»ƒå¤©æ•°</div>
                </div>
                <div class="glass rounded-2xl p-3 text-center card-gradient">
                    <div class="text-2xl font-bold text-purple-400" id="stat-total-volume">0</div>
                    <div class="text-[10px] text-gray-400 mt-1">å®¹é‡(kg)</div>
                </div>
            </div>

            <div class="glass rounded-2xl p-4">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full pulse-ring"></div>
                        <h2 class="font-bold text-lg">é€‰æ‹©ä»Šæ—¥è®­ç»ƒ</h2>
                    </div>
                    <span class="text-xs text-gray-400" id="current-date"></span>
                </div>
                <div class="space-y-3" id="training-types"></div>
            </div>

            <!-- å®‰è£…çŠ¶æ€æç¤º -->
            <div id="install-status" class="glass rounded-2xl p-4 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">ğŸ“²</span>
                        <div>
                            <div class="font-bold text-sm">æ·»åŠ åˆ°ä¸»å±å¹•</div>
                            <div class="text-xs text-gray-400">åƒåŸç”Ÿåº”ç”¨ä¸€æ ·ä½¿ç”¨ï¼Œæ”¯æŒç¦»çº¿è®¿é—®</div>
                        </div>
                    </div>
                    <button onclick="showInstallGuide()" class="bg-blue-600 px-4 py-2 rounded-xl text-sm font-bold">æŸ¥çœ‹æ–¹æ³•</button>
                </div>
            </div>
        </div>

        <!-- è®­ç»ƒé¡µé¢ -->
        <div id="page-workout" class="hidden p-4 space-y-4">
            <div class="flex items-center justify-between mb-4">
                <button onclick="showPage('home')" class="w-10 h-10 glass rounded-xl flex items-center justify-center">â†</button>
                <h2 id="workout-title" class="font-bold text-lg">è®­ç»ƒè®°å½•</h2>
                <button onclick="finishWorkout()" class="bg-green-600 px-4 py-2 rounded-xl text-sm font-bold shadow-lg">å®Œæˆ</button>
            </div>
            <div id="workout-exercises" class="space-y-4"></div>
            <div class="glass rounded-2xl p-4">
                <div class="flex justify-between text-sm text-gray-400 mb-2">
                    <span>æœ¬æ¬¡å®¹é‡</span>
                    <span id="workout-volume" class="text-white font-bold">0 kg</span>
                </div>
                <div class="flex justify-between text-sm text-gray-400">
                    <span>å·²å®Œæˆç»„</span>
                    <span id="workout-sets" class="text-white font-bold">0/0</span>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ¿ç®¡ç†é¡µé¢ -->
        <div id="page-templates" class="hidden p-4 space-y-4">
            <div class="flex items-center justify-between mb-4">
                <button onclick="showPage('home')" class="w-10 h-10 glass rounded-xl flex items-center justify-center">â†</button>
                <h2 class="font-bold text-lg">æ¨¡æ¿ç®¡ç†</h2>
                <div class="flex space-x-2">
                    <button onclick="openTemplateEditor()" class="w-10 h-10 glass rounded-xl flex items-center justify-center text-green-400 text-xl">+</button>
                    <label class="w-10 h-10 glass rounded-xl flex items-center justify-center cursor-pointer hover:bg-white/10">
                        <span>ğŸ“¥</span>
                        <input type="file" accept=".json" class="hidden" onchange="importTemplates(this)">
                    </label>
                </div>
            </div>

            <div class="glass rounded-2xl p-3 flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="select-all-tmpl" onchange="toggleSelectAllTemplates()" class="w-5 h-5 rounded border-gray-600 bg-black/30 text-blue-600">
                    <label for="select-all-tmpl" class="text-sm">å…¨é€‰ <span id="selected-count" class="text-xs text-gray-500"></span></label>
                </div>
                <div class="flex space-x-2" id="batch-actions" style="display: none;">
                    <button onclick="exportSelectedTemplates()" class="px-4 py-2 bg-blue-600 rounded-xl text-sm font-bold">å¯¼å‡º</button>
                    <button onclick="deleteSelectedTemplates()" class="px-4 py-2 bg-red-600/80 rounded-xl text-sm font-bold">åˆ é™¤</button>
                </div>
            </div>

            <div id="template-list" class="space-y-2 max-h-[60vh] overflow-y-auto hide-scrollbar"></div>
        </div>

        <!-- æ•°æ®ç®¡ç†é¡µé¢ -->
        <div id="page-backup" class="hidden p-4 space-y-4">
            <div class="flex items-center justify-between mb-4">
                <button onclick="showPage('home')" class="w-10 h-10 glass rounded-xl flex items-center justify-center">â†</button>
                <h2 class="font-bold text-lg">æ•°æ®ç®¡ç†</h2>
            </div>
            <div class="glass rounded-2xl p-4 space-y-4">
                <div>
                    <h3 class="font-bold mb-2 text-blue-400">è‡ªåŠ¨å¤‡ä»½æœºåˆ¶</h3>
                    <p class="text-sm text-gray-400">æ¯æœˆè‡ªåŠ¨ç”Ÿæˆå¤‡ä»½æ–‡ä»¶ï¼ŒåŒæœˆæ•°æ®è‡ªåŠ¨åˆå¹¶è¦†ç›–ã€‚</p>
                    <p class="text-sm text-blue-400 mt-1">å½“å‰å‘¨æœŸï¼š<span id="current-cycle">--</span></p>
                </div>
                <div class="space-y-2">
                    <button onclick="manualBackup()" class="w-full py-3 bg-blue-600 rounded-xl font-bold text-sm">ç«‹å³å¤‡ä»½æœ¬æœˆæ•°æ®</button>
                    <label class="w-full py-3 bg-gray-700 rounded-xl font-bold text-sm flex items-center justify-center cursor-pointer">
                        <span>ä»æ–‡ä»¶æ¢å¤æ•°æ®</span>
                        <input type="file" accept=".json" class="hidden" onchange="restoreFromFile(this)">
                    </label>
                </div>
                <div class="border-t border-gray-700 pt-4">
                    <h4 class="font-bold mb-2 text-sm">æœ¬åœ°å¤‡ä»½å†å²</h4>
                    <div id="backup-history" class="space-y-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- æ—¥å†é¡µé¢ -->
        <div id="page-calendar" class="hidden p-4 space-y-4">
            <div class="flex items-center justify-between mb-2">
                <button onclick="showPage('home')" class="w-10 h-10 glass rounded-xl flex items-center justify-center">â†</button>
                <div class="flex items-center space-x-4">
                    <button onclick="changeMonth(-1)" class="text-gray-400 hover:text-white text-xl">â€¹</button>
                    <h2 id="calendar-month" class="font-bold text-lg">2025å¹´2æœˆ</h2>
                    <button onclick="changeMonth(1)" class="text-gray-400 hover:text-white text-xl">â€º</button>
                </div>
                <button onclick="goToToday()" class="text-xs text-blue-400 px-3 py-1 bg-blue-500/20 rounded-lg">ä»Šå¤©</button>
            </div>
            
            <div class="glass rounded-2xl p-4">
                <div class="grid grid-cols-7 gap-1 mb-2 text-center text-xs text-gray-500">
                    <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
            </div>

            <div id="day-detail" class="glass rounded-2xl p-4 hidden">
                <h3 class="font-bold mb-3 flex justify-between">
                    <span id="detail-date">2æœˆ12æ—¥</span>
                    <span class="text-sm text-gray-400" id="detail-count"></span>
                </h3>
                <div id="detail-content" class="space-y-3"></div>
            </div>
        </div>

    </div>

    <!-- æ¨¡æ¿ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="template-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="glass w-full max-w-lg max-h-[90vh] overflow-y-auto rounded-t-2xl sm:rounded-2xl p-4 modal-enter hide-scrollbar">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-gray-900/90 backdrop-blur py-2 z-10 border-b border-gray-700">
                <h3 class="font-bold text-lg" id="modal-title">æ–°å»ºæ¨¡æ¿</h3>
                <button onclick="closeTemplateModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">æ¨¡æ¿åç§°</label>
                    <input type="text" id="edit-tmpl-name" placeholder="ä¾‹å¦‚ï¼šèƒ¸è‚Œå¼ºåŒ–è®­ç»ƒ" 
                        class="w-full bg-black/30 border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-sm text-gray-400 mb-1">æ‰€å±åˆ†ç±»</label>
                    <select id="edit-tmpl-type" class="w-full bg-black/30 border border-gray-700 rounded-xl px-4 py-3 text-white focus:border-blue-500 focus:outline-none">
                        <option value="push">æ¨æ—¥ï¼ˆèƒ¸/è‚©/ä¸‰å¤´ï¼‰</option>
                        <option value="pull">æ‹‰æ—¥ï¼ˆèƒŒ/äºŒå¤´ï¼‰</option>
                        <option value="legs">è…¿æ—¥ï¼ˆè…¿/è‡€ï¼‰</option>
                    </select>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm text-gray-400">åŠ¨ä½œåˆ—è¡¨</label>
                        <button onclick="addExerciseInput()" class="text-xs text-blue-400 bg-blue-500/20 px-3 py-1 rounded-lg">+ æ·»åŠ åŠ¨ä½œ</button>
                    </div>
                    <div id="exercise-inputs" class="space-y-2"></div>
                </div>

                <div class="sticky bottom-0 bg-gray-900/90 backdrop-blur pt-2 pb-4 border-t border-gray-700 mt-6">
                    <button onclick="saveTemplateFromModal()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl font-bold text-sm shadow-lg">
                        ä¿å­˜æ¨¡æ¿
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å®‰è£…æŒ‡å¼•å¼¹çª— -->
    <div id="install-guide" class="hidden fixed inset-0 bg-black/90 z-[60] flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-6 max-w-sm w-full">
            <h3 class="font-bold text-lg mb-4">æ·»åŠ åˆ°ä¸»å±å¹•</h3>
            <div class="space-y-3 text-sm text-gray-300">
                <div id="guide-ios" class="hidden">
                    <p>1. ç‚¹å‡»åº•éƒ¨ <span class="text-blue-400 font-bold">åˆ†äº«æŒ‰é’® â¬†ï¸</span></p>
                    <p>2. é€‰æ‹© <span class="text-blue-400 font-bold">"æ·»åŠ åˆ°ä¸»å±å¹•"</span></p>
                    <p>3. ç‚¹å‡» <span class="text-blue-400 font-bold">"æ·»åŠ "</span></p>
                </div>
                <div id="guide-android" class="hidden">
                    <p>1. ç‚¹å‡»å³ä¸Šè§’ <span class="text-blue-400 font-bold">èœå•(â‹®)</span></p>
                    <p>2. é€‰æ‹© <span class="text-blue-400 font-bold">"æ·»åŠ åˆ°ä¸»å±å¹•"</span> æˆ– <span class="text-blue-400 font-bold">"å®‰è£…åº”ç”¨"</span></p>
                    <p>3. ç‚¹å‡» <span class="text-blue-400 font-bold">"æ·»åŠ "</span></p>
                </div>
            </div>
            <button onclick="document.getElementById('install-guide').classList.add('hidden')" class="w-full mt-6 py-3 bg-gray-700 rounded-xl font-bold">çŸ¥é“äº†</button>
        </div>
    </div>

    <div id="toast" class="install-toast"></div>

    <script>
        // ==================== PWA å®‰è£…æ£€æµ‹ä¸å¼•å¯¼ ====================
        let deferredPrompt = null;
        let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        let isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        let isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // æ˜¾ç¤º Android å®‰è£…æŒ‰é’®
            if (!isIOS) {
                document.getElementById('android-install-btn').classList.remove('hidden');
                document.getElementById('install-status').classList.remove('hidden');
            }
        });

        // iOS Safari ç‰¹æ®Šå¤„ç†
        if (isIOS && !isStandalone) {
            // æ£€æŸ¥æ˜¯å¦å·²æ˜¾ç¤ºè¿‡æç¤º
            if (!localStorage.getItem('ios-hint-dismissed')) {
                setTimeout(() => {
                    document.getElementById('ios-install-hint').classList.remove('hidden');
                }, 2000);
            }
            document.getElementById('install-status').classList.remove('hidden');
        }

        // å¦‚æœå·²å®‰è£…ï¼Œéšè—å®‰è£…æç¤º
        if (isStandalone) {
            document.getElementById('install-status')?.classList.add('hidden');
        }

        function dismissIOSHint() {
            document.getElementById('ios-install-hint').classList.add('hidden');
            localStorage.setItem('ios-hint-dismissed', 'true');
        }

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('android-install-btn').classList.add('hidden');
                    showToast('æ­£åœ¨å®‰è£…...');
                }
                deferredPrompt = null;
            } else {
                showInstallGuide();
            }
        }

        function showInstallGuide() {
            const guide = document.getElementById('install-guide');
            guide.classList.remove('hidden');
            if (isIOS) {
                document.getElementById('guide-ios').classList.remove('hidden');
            } else {
                document.getElementById('guide-android').classList.remove('hidden');
            }
        }

        // ==================== é…ç½® ====================
        const CONFIG = {
            DB_NAME: 'gymDB_v8',
            DB_VERSION: 8
        };

        // ==================== å…¨å±€çŠ¶æ€ ====================
        let dbManager, backupManager, templateManager;
        let currentWorkout = null;
        let selectedTemplates = new Set();
        let editingTemplateId = null;
        let currentCalendarDate = new Date();

        // ==================== Service Worker ====================
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'gym-pro-v1';
                const urlsToCache = ['./'];
                
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => cache.addAll(urlsToCache))
                    );
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', event => {
                    event.waitUntil(self.clients.claim());
                });
                
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) return response;
                                return fetch(event.request);
                            })
                    );
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob))
                .then(() => console.log('SW registered'))
                .catch(err => console.log('SW failed', err));
        }

        // ==================== å·¥å…·å‡½æ•° ====================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        // ==================== æ•°æ®åº“ç®¡ç† ====================
        class DatabaseManager {
            constructor() {
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('types')) {
                            const store = db.createObjectStore('types', { keyPath: 'key' });
                            store.transaction.oncomplete = () => this.initDefaultData(db);
                        }
                        if (!db.objectStoreNames.contains('records')) {
                            db.createObjectStore('records', { keyPath: 'date' });
                        }
                    };
                });
            }

            initDefaultData(db) {
                const defaults = [
                    { key: 'push', name: 'æ¨æ—¥', icon: 'ğŸ’ª', color: 'blue', templates: [] },
                    { key: 'pull', name: 'æ‹‰æ—¥', icon: 'ğŸ”ï¸', color: 'purple', templates: [] },
                    { key: 'legs', name: 'è…¿æ—¥', icon: 'ğŸ¦µ', color: 'green', templates: [] }
                ];
                const tx = db.transaction(['types'], 'readwrite');
                defaults.forEach(d => tx.objectStore('types').add(d));
            }

            async getTypes() { return this.getAll('types'); }
            async getRecords() { return this.getAll('records'); }
            
            async getRecord(date) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['records'], 'readonly');
                    const req = tx.objectStore('records').get(date);
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            }

            async saveRecord(record) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['records'], 'readwrite');
                    const req = tx.objectStore('records').put(record);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            }

            async updateType(typeData) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction(['types'], 'readwrite');
                    const req = tx.objectStore('types').put(typeData);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            }

            getAll(storeName) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction([storeName], 'readonly');
                    const req = tx.objectStore(storeName).getAll();
                    req.onsuccess = () => resolve(req.result || []);
                    req.onerror = () => reject(req.error);
                });
            }
        }

        // ==================== å¤‡ä»½ç®¡ç†å™¨ ====================
        class BackupManager {
            constructor(dbManager) {
                this.db = dbManager;
            }

            getCycleId() {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }

            getCycleDateRange() {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                return {
                    start: new Date(year, month, 1).toLocaleDateString('zh-CN'),
                    end: new Date(year, month + 1, 0).toLocaleDateString('zh-CN'),
                    month: `${year}å¹´${month + 1}æœˆ`
                };
            }

            async backupAfterTraining(trainingRecord) {
                try {
                    const cycleId = this.getCycleId();
                    const fileName = `è®­ç»ƒè®°å½•_${cycleId}.json`;
                    
                    const existing = await this.getExistingBackup(cycleId);
                    let records = existing ? existing.records : [];
                    
                    const idx = records.findIndex(r => r.date === trainingRecord.date);
                    if (idx >= 0) records[idx] = trainingRecord;
                    else records.push(trainingRecord);

                    const backupData = {
                        version: CONFIG.DB_VERSION,
                        type: 'training_records',
                        exportDate: new Date().toISOString(),
                        cycleId: cycleId,
                        cycleRange: this.getCycleDateRange(),
                        records: records
                    };

                    this.downloadFile(backupData, fileName);
                    localStorage.setItem(`gym_backup_${cycleId}`, JSON.stringify(backupData));
                    
                    return { success: true, fileName, cycle: cycleId };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            getExistingBackup(cycleId) {
                const data = localStorage.getItem(`gym_backup_${cycleId}`);
                return data ? JSON.parse(data) : null;
            }

            downloadFile(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            async getBackupHistory() {
                const history = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('gym_backup_')) {
                        const cycleId = key.replace('gym_backup_', '');
                        const data = JSON.parse(localStorage.getItem(key));
                        history.push({
                            cycleId: cycleId,
                            month: data.cycleRange.month,
                            recordCount: data.records ? data.records.length : 0,
                            lastBackup: data.exportDate
                        });
                    }
                }
                return history.sort((a, b) => b.cycleId.localeCompare(a.cycleId));
            }
        }

        // ==================== æ¨¡æ¿ç®¡ç†å™¨ ====================
        class TemplateManager {
            constructor(dbManager) {
                this.db = dbManager;
            }

            async getAllTemplatesWithPath() {
                const types = await this.db.getTypes();
                const templates = [];
                const typeNames = { push: 'æ¨æ—¥', pull: 'æ‹‰æ—¥', legs: 'è…¿æ—¥' };
                
                types.forEach(type => {
                    if (type.templates) {
                        type.templates.forEach((tmpl, index) => {
                            templates.push({
                                ...tmpl,
                                uniqueId: `${type.key}_${tmpl.id || index}`,
                                typeKey: type.key,
                                typeName: typeNames[type.key],
                                path: `${typeNames[type.key]}/${tmpl.name}`,
                                color: type.color,
                                realIndex: index
                            });
                        });
                    }
                });
                return templates;
            }

            async deleteTemplate(uniqueId) {
                const [typeKey, templateId] = uniqueId.split('_');
                
                return new Promise(async (resolve, reject) => {
                    try {
                        const types = await this.db.getTypes();
                        const typeData = types.find(t => t.key === typeKey);
                        
                        if (!typeData || !typeData.templates) {
                            reject(new Error('åˆ†ç±»ä¸å­˜åœ¨'));
                            return;
                        }
                        
                        const originalLength = typeData.templates.length;
                        typeData.templates = typeData.templates.filter(t => {
                            const tId = t.id || `${typeKey}_${typeData.templates.indexOf(t)}`;
                            return tId !== templateId && t.id !== templateId;
                        });
                        
                        if (typeData.templates.length === originalLength) {
                            reject(new Error('æ¨¡æ¿æœªæ‰¾åˆ°'));
                            return;
                        }
                        
                        await this.db.updateType(typeData);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            async deleteBatch(uniqueIds) {
                let count = 0;
                for (const id of uniqueIds) {
                    try {
                        await this.deleteTemplate(id);
                        count++;
                    } catch (e) {}
                }
                return count;
            }

            async saveTemplate(templateData, targetTypeKey, originalId = null) {
                const types = await this.db.getTypes();
                const typeData = types.find(t => t.key === targetTypeKey);
                
                if (!typeData) throw new Error('åˆ†ç±»ä¸å­˜åœ¨');

                const newTemplate = {
                    id: originalId || Date.now().toString(),
                    name: templateData.name,
                    exercises: templateData.exercises.map(e => ({
                        name: e.name,
                        sets: parseInt(e.sets) || 3,
                        defaultReps: parseInt(e.reps) || 10,
                        defaultWeight: parseInt(e.weight) || 0,
                        video: '',
                        note: ''
                    })),
                    updatedAt: new Date().toISOString()
                };

                if (!originalId) {
                    newTemplate.createdAt = new Date().toISOString();
                    typeData.templates.push(newTemplate);
                } else {
                    const idx = typeData.templates.findIndex(t => t.id === originalId);
                    if (idx >= 0) {
                        newTemplate.createdAt = typeData.templates[idx].createdAt;
                        typeData.templates[idx] = newTemplate;
                    } else {
                        typeData.templates.push(newTemplate);
                    }
                }

                await this.db.updateType(typeData);
                return newTemplate;
            }

            async getTemplateForEdit(uniqueId) {
                const all = await this.getAllTemplatesWithPath();
                return all.find(t => t.uniqueId === uniqueId);
            }

            exportSingle(template) {
                const data = {
                    type: 'single_template',
                    version: CONFIG.DB_VERSION,
                    exportDate: new Date().toISOString(),
                    template: { ...template, preservedPath: template.path }
                };
                const safeName = template.name.replace(/[\\/:*?"<>|]/g, '_');
                this.downloadJSON(data, `æ¨¡æ¿_${safeName}.json`);
            }

            exportBatch(templates) {
                const data = {
                    type: 'template_batch',
                    version: CONFIG.DB_VERSION,
                    exportDate: new Date().toISOString(),
                    count: templates.length,
                    templates: templates.map(t => ({ ...t, preservedPath: t.path }))
                };
                const date = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');
                this.downloadJSON(data, `æ¨¡æ¿æ‰¹é‡_${date}_${templates.length}ä¸ª.json`);
            }

            async importFromFile(content) {
                try {
                    const data = JSON.parse(content);
                    if (data.type === 'training_records') {
                        return { success: false, message: 'âš ï¸ è¿™æ˜¯è®­ç»ƒè®°å½•å¤‡ä»½ï¼Œè¯·åœ¨ã€Œæ•°æ®ç®¡ç†ã€é¡µé¢æ¢å¤' };
                    }

                    if (data.types && typeof data.types === 'object' && !Array.isArray(data.types)) {
                        let count = 0;
                        for (const [typeKey, typeData] of Object.entries(data.types)) {
                            if (typeData && typeData.templates && Array.isArray(typeData.templates)) {
                                for (const template of typeData.templates) {
                                    await this.saveTemplate({
                                        name: template.name,
                                        exercises: template.exercises || []
                                    }, typeKey);
                                    count++;
                                }
                            }
                        }
                        return { success: true, count, message: `âœ… æˆåŠŸå¯¼å…¥ ${count} ä¸ªæ¨¡æ¿` };
                    }

                    if (data.type === 'single_template') {
                        const typeKey = this.inferTypeFromPath(data.template.preservedPath) || 'push';
                        await this.saveTemplate(data.template, typeKey);
                        return { success: true, count: 1, message: `å·²å¯¼å…¥ï¼š${data.template.name}` };
                    }

                    if (data.type === 'template_batch') {
                        let count = 0;
                        for (const tmpl of data.templates) {
                            const typeKey = this.inferTypeFromPath(tmpl.preservedPath) || 'push';
                            await this.saveTemplate(tmpl, typeKey);
                            count++;
                        }
                        return { success: true, count, message: `æˆåŠŸå¯¼å…¥ ${count} ä¸ªæ¨¡æ¿` };
                    }

                    return { success: false, message: 'æ— æ³•è¯†åˆ«çš„æ–‡ä»¶æ ¼å¼' };
                } catch (error) {
                    return { success: false, message: 'è§£æå¤±è´¥ï¼š' + error.message };
                }
            }

            inferTypeFromPath(path) {
                if (!path) return 'push';
                if (path.includes('æ¨') || path.includes('push')) return 'push';
                if (path.includes('æ‹‰') || path.includes('pull')) return 'pull';
                if (path.includes('è…¿') || path.includes('legs')) return 'legs';
                return 'push';
            }

            downloadJSON(data, filename) {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // ==================== UIæ§åˆ¶ ====================
        function showPage(pageName) {
            ['home', 'workout', 'templates', 'backup', 'calendar'].forEach(p => {
                document.getElementById(`page-${p}`).classList.add('hidden');
            });
            const target = document.getElementById(`page-${pageName}`);
            target.classList.remove('hidden');
            target.classList.add('fade-in');
            
            if (pageName === 'templates') loadTemplateList();
            if (pageName === 'backup') loadBackupInfo();
            if (pageName === 'calendar') renderCalendar();
            if (pageName === 'home') initHome();
        }

        // ==================== é¦–é¡µ ====================
        async function initHome() {
            const types = await dbManager.getTypes();
            const container = document.getElementById('training-types');
            container.innerHTML = '';
            
            types.forEach(type => {
                const btn = document.createElement('div');
                btn.className = 'w-full glass rounded-xl p-4 hover:bg-white/5 transition';
                btn.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 rounded-full bg-${type.color}-500/20 flex items-center justify-center text-2xl">${type.icon}</div>
                            <div>
                                <div class="font-bold text-lg">${type.name}</div>
                                <div class="text-xs text-gray-400">${type.templates ? type.templates.length : 0} ä¸ªæ¨¡æ¿</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-2">
                        ${type.templates.map((t, i) => `
                            <button onclick="event.stopPropagation(); startWorkout('${type.key}', ${i})" 
                                class="px-3 py-1.5 bg-${type.color}-600/30 border border-${type.color}-500/30 rounded-lg text-xs hover:bg-${type.color}-600/50 whitespace-nowrap">
                                ${t.name}
                            </button>
                        `).join('')}
                    </div>
                `;
                container.appendChild(btn);
            });

            document.getElementById('current-date').textContent = new Date().toLocaleDateString('zh-CN', { 
                month: 'long', day: 'numeric', weekday: 'long' 
            });
            updateHomeStats();
        }

        async function updateHomeStats() {
            const records = await dbManager.getRecords();
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthRecords = records.filter(r => {
                const d = new Date(r.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
            
            let totalSets = 0, totalVolume = 0;
            const uniqueDays = new Set();
            
            monthRecords.forEach(r => {
                uniqueDays.add(r.date);
                if (r.exercises) {
                    r.exercises.forEach(e => {
                        if (e.sets) {
                            e.sets.forEach(s => {
                                if (s.completed) {
                                    totalSets++;
                                    totalVolume += (s.weight || 0) * (s.reps || 0);
                                }
                            });
                        }
                    });
                }
            });
            
            document.getElementById('stat-month-count').textContent = monthRecords.length;
            document.getElementById('stat-total-sets').textContent = totalSets;
            document.getElementById('stat-total-days').textContent = uniqueDays.size;
            document.getElementById('stat-total-volume').textContent = totalVolume > 999 ? (totalVolume/1000).toFixed(1) + 'k' : totalVolume;
        }

        // ==================== è®­ç»ƒåŠŸèƒ½ ====================
        async function startWorkout(typeKey, templateIndex) {
            const types = await dbManager.getTypes();
            const type = types.find(t => t.key === typeKey);
            const template = type.templates[templateIndex];
            
            currentWorkout = {
                date: new Date().toISOString().split('T')[0],
                typeKey: typeKey,
                templateName: template.name,
                exercises: template.exercises.map(e => ({
                    ...e,
                    sets: Array(e.sets || 3).fill(0).map((_, i) => ({
                        setNum: i + 1,
                        reps: e.defaultReps || 10,
                        weight: e.defaultWeight || 0,
                        completed: false
                    }))
                })),
                startTime: new Date().toISOString(),
                completed: false
            };
            
            document.getElementById('workout-title').textContent = template.name;
            renderWorkout();
            showPage('workout');
        }

        function renderWorkout() {
            const container = document.getElementById('workout-exercises');
            container.innerHTML = '';
            let totalSets = 0, completedSets = 0, totalVolume = 0;
            
            currentWorkout.exercises.forEach((ex, exIndex) => {
                const exDiv = document.createElement('div');
                exDiv.className = 'glass rounded-2xl p-4';
                
                let setsHtml = '';
                ex.sets.forEach((set, setIndex) => {
                    totalSets++;
                    if (set.completed) {
                        completedSets++;
                        totalVolume += (set.weight || 0) * (set.reps || 0);
                    }
                    
                    setsHtml += `
                        <div class="flex items-center space-x-2 mt-2">
                            <span class="text-xs text-gray-400 w-8">ç¬¬${set.setNum}ç»„</span>
                            <input type="number" value="${set.weight}" onchange="updateSet(${exIndex}, ${setIndex}, 'weight', this.value)" 
                                class="w-16 bg-black/30 border border-gray-700 rounded-lg px-2 py-1 text-center text-sm">
                            <span class="text-gray-500">kg Ã—</span>
                            <input type="number" value="${set.reps}" onchange="updateSet(${exIndex}, ${setIndex}, 'reps', this.value)" 
                                class="w-16 bg-black/30 border border-gray-700 rounded-lg px-2 py-1 text-center text-sm">
                            <button onclick="toggleSetComplete(${exIndex}, ${setIndex})" 
                                class="flex-1 py-1.5 rounded-lg text-sm font-bold transition ${set.completed ? 'bg-green-600 text-white' : 'bg-gray-700 text-gray-400'}">
                                ${set.completed ? 'âœ“ å®Œæˆ' : 'æœªå®Œæˆ'}
                            </button>
                        </div>
                    `;
                });
                
                exDiv.innerHTML = `
                    <div class="flex justify-between mb-3">
                        <h3 class="font-bold">${ex.name}</h3>
                        <button onclick="addSet(${exIndex})" class="text-xs text-blue-400">+ æ·»åŠ ç»„</button>
                    </div>
                    ${setsHtml}
                `;
                container.appendChild(exDiv);
            });
            
            document.getElementById('workout-sets').textContent = `${completedSets}/${totalSets}`;
            document.getElementById('workout-volume').textContent = `${totalVolume} kg`;
        }

        function updateSet(exIndex, setIndex, field, value) {
            currentWorkout.exercises[exIndex].sets[setIndex][field] = Number(value) || 0;
        }

        function toggleSetComplete(exIndex, setIndex) {
            const set = currentWorkout.exercises[exIndex].sets[setIndex];
            set.completed = !set.completed;
            if (set.completed) set.completedAt = new Date().toISOString();
            renderWorkout();
        }

        function addSet(exIndex) {
            const ex = currentWorkout.exercises[exIndex];
            ex.sets.push({
                setNum: ex.sets.length + 1,
                reps: ex.defaultReps || 10,
                weight: ex.defaultWeight || 0,
                completed: false
            });
            renderWorkout();
        }

        async function finishWorkout() {
            currentWorkout.completed = true;
            currentWorkout.completedAt = new Date().toISOString();
            
            await dbManager.saveRecord(currentWorkout);
            
            const result = await backupManager.backupAfterTraining(currentWorkout);
            if (result.success) {
                showToast(`è®­ç»ƒå®Œæˆï¼å·²å¤‡ä»½è‡³ ${result.cycle}`);
            } else {
                showToast('è®­ç»ƒå·²ä¿å­˜ï¼Œå¤‡ä»½å¤±è´¥');
            }
            
            showPage('home');
            updateHomeStats();
        }

        // ==================== æ¨¡æ¿ç®¡ç† ====================
        async function loadTemplateList() {
            const templates = await templateManager.getAllTemplatesWithPath();
            const container = document.getElementById('template-list');
            container.innerHTML = '';
            
            selectedTemplates.clear();
            updateBatchActions();
            document.getElementById('select-all-tmpl').checked = false;
            
            if (templates.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8 text-sm">æš‚æ— æ¨¡æ¿ï¼Œç‚¹å‡»å³ä¸Šè§’ + åˆ›å»º</div>';
                return;
            }
            
            templates.forEach(t => {
                const div = document.createElement('div');
                div.className = 'glass rounded-xl p-3 flex items-center space-x-3 hover:bg-white/5 transition group';
                div.innerHTML = `
                    <input type="checkbox" value="${t.uniqueId}" onchange="toggleTemplateSelect('${t.uniqueId}')" 
                        class="w-5 h-5 rounded border-gray-600 bg-black/30 text-blue-600 shrink-0">
                    <div class="flex-1 min-w-0" onclick="openTemplateEditor('${t.uniqueId}')">
                        <div class="font-bold text-sm truncate">${t.name}</div>
                        <div class="flex items-center space-x-2 mt-1 flex-wrap gap-y-1">
                            <span class="text-[10px] px-2 py-0.5 bg-${t.color}-500/20 text-${t.color}-400 rounded border border-${t.color}-500/30">${t.path}</span>
                            <span class="text-[10px] text-gray-500">${t.exercises ? t.exercises.length : 0} åŠ¨ä½œ</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition">
                        <button onclick='event.stopPropagation(); templateManager.exportSingle(${JSON.stringify(t)}); showToast("å·²å¯¼å‡º")' 
                            class="p-2 text-gray-400 hover:text-blue-400">ğŸ“¤</button>
                        <button onclick='event.stopPropagation(); deleteTemplatePrompt("${t.uniqueId}", "${t.name.replace(/"/g, '\\"')}")' 
                            class="p-2 text-gray-400 hover:text-red-400">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleTemplateSelect(id) {
            if (selectedTemplates.has(id)) selectedTemplates.delete(id);
            else selectedTemplates.add(id);
            updateBatchActions();
        }

        function updateBatchActions() {
            const count = selectedTemplates.size;
            document.getElementById('batch-actions').style.display = count > 0 ? 'flex' : 'none';
            document.getElementById('selected-count').textContent = count > 0 ? `(${count})` : '';
        }

        function toggleSelectAllTemplates() {
            const checkboxes = document.querySelectorAll('#template-list input[type="checkbox"]');
            const allChecked = document.getElementById('select-all-tmpl').checked;
            
            checkboxes.forEach(cb => {
                cb.checked = allChecked;
                if (allChecked) selectedTemplates.add(cb.value);
                else selectedTemplates.delete(cb.value);
            });
            updateBatchActions();
        }

        // ==================== æ¨¡æ¿ç¼–è¾‘å™¨ ====================
        function openTemplateEditor(uniqueId = null) {
            editingTemplateId = uniqueId;
            document.getElementById('template-modal').classList.remove('hidden');
            document.getElementById('exercise-inputs').innerHTML = '';
            
            if (uniqueId) {
                document.getElementById('modal-title').textContent = 'ç¼–è¾‘æ¨¡æ¿';
                loadTemplateForEdit(uniqueId);
            } else {
                document.getElementById('modal-title').textContent = 'æ–°å»ºæ¨¡æ¿';
                document.getElementById('edit-tmpl-name').value = '';
                document.getElementById('edit-tmpl-type').value = 'push';
                addExerciseInput();
            }
        }

        async function loadTemplateForEdit(uniqueId) {
            const tmpl = await templateManager.getTemplateForEdit(uniqueId);
            if (!tmpl) return;
            
            document.getElementById('edit-tmpl-name').value = tmpl.name;
            document.getElementById('edit-tmpl-type').value = tmpl.typeKey;
            
            tmpl.exercises.forEach(ex => {
                addExerciseInput(ex.name, ex.sets, ex.defaultReps, ex.defaultWeight);
            });
        }

        function addExerciseInput(name = '', sets = 3, reps = 10, weight = 0) {
            const container = document.getElementById('exercise-inputs');
            const div = document.createElement('div');
            div.className = 'glass rounded-xl p-3 space-y-2';
            div.innerHTML = `
                <div class="flex justify-between">
                    <input type="text" placeholder="åŠ¨ä½œåç§°" value="${name}" class="ex-name flex-1 bg-black/30 border border-gray-700 rounded-lg px-3 py-2 text-sm mr-2">
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-500 hover:text-red-400">âœ•</button>
                </div>
                <div class="flex space-x-2">
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-500">ç»„æ•°</label>
                        <input type="number" value="${sets}" class="ex-sets w-full bg-black/30 border border-gray-700 rounded-lg px-2 py-1 text-sm text-center">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-500">æ¬¡æ•°</label>
                        <input type="number" value="${reps}" class="ex-reps w-full bg-black/30 border border-gray-700 rounded-lg px-2 py-1 text-sm text-center">
                    </div>
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-500">é‡é‡(kg)</label>
                        <input type="number" value="${weight}" class="ex-weight w-full bg-black/30 border border-gray-700 rounded-lg px-2 py-1 text-sm text-center">
                    </div>
                </div>
            `;
            container.appendChild(div);
        }

        function closeTemplateModal() {
            document.getElementById('template-modal').classList.add('hidden');
            editingTemplateId = null;
        }

        async function saveTemplateFromModal() {
            const name = document.getElementById('edit-tmpl-name').value.trim();
            const typeKey = document.getElementById('edit-tmpl-type').value;
            
            if (!name) {
                showToast('è¯·è¾“å…¥æ¨¡æ¿åç§°');
                return;
            }
            
            const exercises = [];
            const rows = document.querySelectorAll('#exercise-inputs > div');
            rows.forEach(row => {
                const name = row.querySelector('.ex-name').value.trim();
                if (name) {
                    exercises.push({
                        name: name,
                        sets: row.querySelector('.ex-sets').value,
                        reps: row.querySelector('.ex-reps').value,
                        weight: row.querySelector('.ex-weight').value
                    });
                }
            });
            
            if (exercises.length === 0) {
                showToast('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªåŠ¨ä½œ');
                return;
            }
            
            try {
                let originalId = null;
                if (editingTemplateId) {
                    const parts = editingTemplateId.split('_');
                    originalId = parts[1];
                }
                
                await templateManager.saveTemplate({ name, exercises }, typeKey, originalId);
                
                showToast(editingTemplateId ? 'æ¨¡æ¿å·²æ›´æ–°' : 'æ¨¡æ¿åˆ›å»ºæˆåŠŸ');
                closeTemplateModal();
                loadTemplateList();
                initHome();
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        async function deleteTemplatePrompt(uniqueId, name) {
            if (confirm(`ç¡®å®šåˆ é™¤æ¨¡æ¿ã€Œ${name}ã€å—ï¼Ÿä¸å¯æ¢å¤ã€‚`)) {
                try {
                    await templateManager.deleteTemplate(uniqueId);
                    showToast(`å·²åˆ é™¤ï¼š${name}`);
                    loadTemplateList();
                    initHome();
                } catch (error) {
                    showToast('åˆ é™¤å¤±è´¥');
                }
            }
        }

        async function deleteSelectedTemplates() {
            if (selectedTemplates.size === 0) return;
            if (!confirm(`ç¡®å®šåˆ é™¤ ${selectedTemplates.size} ä¸ªæ¨¡æ¿å—ï¼Ÿä¸å¯æ¢å¤ã€‚`)) return;
            
            const count = await templateManager.deleteBatch(Array.from(selectedTemplates));
            showToast(`å·²åˆ é™¤ ${count} ä¸ªæ¨¡æ¿`);
            selectedTemplates.clear();
            loadTemplateList();
            initHome();
        }

        function exportSelectedTemplates() {
            if (selectedTemplates.size === 0) {
                showToast('è¯·å…ˆé€‰æ‹©æ¨¡æ¿');
                return;
            }
            templateManager.getAllTemplatesWithPath().then(templates => {
                const selected = templates.filter(t => selectedTemplates.has(t.uniqueId));
                if (selected.length === 1) templateManager.exportSingle(selected[0]);
                else templateManager.exportBatch(selected);
                showToast(`å·²å¯¼å‡º ${selected.length} ä¸ªæ¨¡æ¿`);
            });
        }

        async function importTemplates(input) {
            const file = input.files[0];
            if (!file) return;
            const content = await file.text();
            const result = await templateManager.importFromFile(content);
            showToast(result.message);
            if (result.success) {
                loadTemplateList();
                initHome();
            }
            input.value = '';
        }

        // ==================== æ—¥å†åŠŸèƒ½ ====================
        async function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('calendar-month').textContent = `${year}å¹´${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startOffset = firstDay.getDay();
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const records = await dbManager.getRecords();
            const monthRecords = records.filter(r => {
                const d = new Date(r.date);
                return d.getFullYear() === year && d.getMonth() === month;
            });
            const trainingDays = new Set(monthRecords.map(r => new Date(r.date).getDate()));
            
            for (let i = 0; i < startOffset; i++) {
                const div = document.createElement('div');
                grid.appendChild(div);
            }
            
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const div = document.createElement('div');
                const isToday = today.getDate() === day && today.getMonth() === month && today.getFullYear() === year;
                const hasTraining = trainingDays.has(day);
                
                div.className = `calendar-day cursor-pointer ${isToday ? 'today' : ''} ${hasTraining ? 'has-training' : 'bg-black/20 text-gray-500'}`;
                div.innerHTML = `
                    <span>${day}</span>
                    ${hasTraining ? '<div class="training-dot"></div>' : ''}
                `;
                
                div.onclick = () => showDayDetail(year, month, day, monthRecords.find(r => new Date(r.date).getDate() === day));
                grid.appendChild(div);
            }
            
            document.getElementById('day-detail').classList.add('hidden');
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            currentCalendarDate = new Date();
            renderCalendar();
        }

        function showDayDetail(year, month, day, record) {
            const detailDiv = document.getElementById('day-detail');
            const contentDiv = document.getElementById('detail-content');
            const dateStr = `${month + 1}æœˆ${day}æ—¥`;
            
            document.getElementById('detail-date').textContent = dateStr;
            
            if (!record) {
                contentDiv.innerHTML = '<div class="text-gray-500 text-sm">å½“æ—¥æ— è®­ç»ƒè®°å½•</div>';
                document.getElementById('detail-count').textContent = '';
            } else {
                let totalSets = 0, totalVolume = 0;
                let html = `<div class="text-sm text-gray-400 mb-2">${record.templateName || 'è‡ªå®šä¹‰è®­ç»ƒ'}</div>`;
                
                html += '<div class="space-y-2">';
                record.exercises.forEach(ex => {
                    const completedSets = ex.sets.filter(s => s.completed).length;
                    const exerciseVolume = ex.sets.reduce((sum, s) => s.completed ? sum + (s.weight * s.reps) : sum, 0);
                    totalSets += completedSets;
                    totalVolume += exerciseVolume;
                    
                    html += `
                        <div class="glass rounded-lg p-2 text-sm">
                            <div class="font-bold mb-1">${ex.name}</div>
                            <div class="text-xs text-gray-400">
                                ${ex.sets.map(s => `${s.weight}kgÃ—${s.reps}${s.completed ? 'âœ“' : ''}`).join(' | ')}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                contentDiv.innerHTML = html;
                document.getElementById('detail-count').textContent = `${totalSets}ç»„ Â· ${totalVolume}kg`;
            }
            
            detailDiv.classList.remove('hidden');
        }

        // ==================== æ•°æ®ç®¡ç† ====================
        async function loadBackupInfo() {
            document.getElementById('current-cycle').textContent = backupManager.getCycleDateRange().month;
            
            const history = await backupManager.getBackupHistory();
            const container = document.getElementById('backup-history');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-xs">æš‚æ— å¤‡ä»½è®°å½•</div>';
                return;
            }
            
            container.innerHTML = history.map(h => `
                <div class="flex justify-between p-2 bg-black/20 rounded-lg">
                    <div>
                        <div class="text-xs font-bold">${h.month}</div>
                        <div class="text-[10px] text-gray-500">${h.recordCount} æ¡è®°å½•</div>
                    </div>
                    <div class="text-[10px] text-gray-500">${new Date(h.lastBackup).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        async function manualBackup() {
            const records = await dbManager.getRecords();
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthRecords = records.filter(r => r.date.startsWith(currentMonth));
            
            if (monthRecords.length === 0) {
                showToast('æœ¬æœˆæš‚æ— è®­ç»ƒè®°å½•');
                return;
            }
            
            const backupData = {
                version: CONFIG.DB_VERSION,
                type: 'training_records',
                exportDate: new Date().toISOString(),
                cycleId: currentMonth,
                cycleRange: backupManager.getCycleDateRange(),
                records: monthRecords
            };
            
            backupManager.downloadFile(backupData, `è®­ç»ƒè®°å½•_${currentMonth}.json`);
            localStorage.setItem(`gym_backup_${currentMonth}`, JSON.stringify(backupData));
            showToast(`å·²å¤‡ä»½æœ¬æœˆ ${monthRecords.length} æ¡è®°å½•`);
            loadBackupInfo();
        }

        async function restoreFromFile(input) {
            const file = input.files[0];
            if (!file) return;
            const content = await file.text();
            const data = JSON.parse(content);
            
            if (data.type !== 'training_records') {
                showToast('è¯·é€‰æ‹©è®­ç»ƒè®°å½•å¤‡ä»½æ–‡ä»¶');
                return;
            }
            
            if (confirm(`æ¢å¤ ${data.cycleRange.month} çš„æ•°æ®ï¼Ÿå°†åˆå¹¶åˆ°ç°æœ‰è®°å½•ã€‚`)) {
                for (const record of data.records) {
                    await dbManager.saveRecord(record);
                }
                showToast(`å·²æ¢å¤ ${data.records.length} æ¡è®°å½•`);
                updateHomeStats();
            }
            input.value = '';
        }

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', async () => {
            dbManager = new DatabaseManager();
            await dbManager.init();
            
            backupManager = new BackupManager(dbManager);
            templateManager = new TemplateManager(dbManager);
            
            initHome();
        });
    </script>
</body>
</html>
